import{AnimationClip,AnimationMixer,Matrix4,Quaternion,QuaternionKeyframeTrack,SkeletonHelper,Vector3,VectorKeyframeTrack}from"./three.module.min.js";function getBoneName(e,t){return t.getBoneName!==void 0?t.getBoneName(e):t.names[e.name]}function retarget(e,t,n={}){const u=new Quaternion,r=new Vector3,i=new Matrix4,o=new Matrix4;n.preserveBoneMatrix=n.preserveBoneMatrix===void 0||n.preserveBoneMatrix,n.preserveBonePositions=n.preserveBonePositions===void 0||n.preserveBonePositions,n.useTargetMatrix=n.useTargetMatrix!==void 0&&n.useTargetMatrix,n.hip=n.hip!==void 0?n.hip:"hip",n.hipInfluence=n.hipInfluence!==void 0?n.hipInfluence:new Vector3(1,1,1),n.scale=n.scale!==void 0?n.scale:1,n.names=n.names||{};const h=t.isObject3D?t.skeleton.bones:getBones(t),a=e.isObject3D?e.skeleton.bones:getBones(e);let s,c,l,d;if(e.isObject3D?e.skeleton.pose():(n.useTargetMatrix=!0,n.preserveBoneMatrix=!1),n.preserveBonePositions){d=[];for(let e=0;e<a.length;e++)d.push(a[e].position.clone())}if(n.preserveBoneMatrix){e.updateMatrixWorld(),e.matrixWorld.identity();for(let t=0;t<e.children.length;++t)e.children[t].updateMatrixWorld(!0)}for(let t=0;t<a.length;++t)s=a[t],c=getBoneName(s,n),l=getBoneByName(c,h),o.copy(s.matrixWorld),l&&(l.updateMatrixWorld(),n.useTargetMatrix?i.copy(l.matrixWorld):(i.copy(e.matrixWorld).invert(),i.multiply(l.matrixWorld)),r.setFromMatrixScale(i),i.scale(r.set(1/r.x,1/r.y,1/r.z)),o.makeRotationFromQuaternion(u.setFromRotationMatrix(i)),e.isObject3D&&n.localOffsets&&n.localOffsets[s.name]&&o.multiply(n.localOffsets[s.name]),o.copyPosition(i)),c===n.hip&&(o.elements[12]*=n.scale*n.hipInfluence.x,o.elements[13]*=n.scale*n.hipInfluence.y,o.elements[14]*=n.scale*n.hipInfluence.z,n.hipPosition!==void 0&&(o.elements[12]+=n.hipPosition.x*n.scale,o.elements[13]+=n.hipPosition.y*n.scale,o.elements[14]+=n.hipPosition.z*n.scale)),s.parent?(s.matrix.copy(s.parent.matrixWorld).invert(),s.matrix.multiply(o)):s.matrix.copy(o),s.matrix.decompose(s.position,s.quaternion,s.scale),s.updateMatrixWorld();if(n.preserveBonePositions)for(let e=0;e<a.length;++e)s=a[e],c=getBoneName(s,n)||s.name,c!==n.hip&&s.position.copy(d[e]);n.preserveBoneMatrix&&e.updateMatrixWorld(!0)}function retargetClip(e,t,n,s={}){s.useFirstFramePosition=s.useFirstFramePosition!==void 0&&s.useFirstFramePosition,s.fps=s.fps!==void 0?s.fps:Math.max(...n.tracks.map(e=>e.times.length))/n.duration,s.names=s.names||[],t.isObject3D||(t=getHelperFromSkeleton(t));const l=Math.round(n.duration*(s.fps/1e3)*1e3),h=n.duration/(l-1),d=[],r=new AnimationMixer(t),m=getBones(e.skeleton),c=[];let f,i,p,o,u;r.clipAction(n).play();let g=0,a=l;s.trim!==void 0?(g=Math.round(s.trim[0]*s.fps),a=Math.min(Math.round(s.trim[1]*s.fps),l)-g,r.update(s.trim[0])):r.update(0),t.updateMatrixWorld();for(let n=0;n<a;++n){const l=n*h;retarget(e,t,s);for(let e=0;e<m.length;++e)i=m[e],u=getBoneName(i,s)||i.name,p=getBoneByName(u,t.skeleton),p&&(o=c[e]=c[e]||{bone:i},s.hip===u&&(o.pos||(o.pos={times:new Float32Array(a),values:new Float32Array(a*3)}),s.useFirstFramePosition&&(n===0&&(f=i.position.clone()),i.position.sub(f)),o.pos.times[n]=l,i.position.toArray(o.pos.values,n*3)),o.quat||(o.quat={times:new Float32Array(a),values:new Float32Array(a*4)}),o.quat.times[n]=l,i.quaternion.toArray(o.quat.values,n*4));n===a-2?r.update(h-1e-7):r.update(h),t.updateMatrixWorld()}for(let e=0;e<c.length;++e)o=c[e],o&&(o.pos&&d.push(new VectorKeyframeTrack(".bones["+o.bone.name+"].position",o.pos.times,o.pos.values)),d.push(new QuaternionKeyframeTrack(".bones["+o.bone.name+"].quaternion",o.quat.times,o.quat.values)));return r.uncacheAction(n),new AnimationClip(n.name,-1,d)}function clone(e){const n=new Map,s=new Map,t=e.clone();return parallelTraverse(e,t,function(e,t){n.set(t,e),s.set(e,t)}),t.traverse(function(e){if(!e.isSkinnedMesh)return;const t=e,o=n.get(e),i=o.skeleton.bones;t.skeleton=o.skeleton.clone(),t.bindMatrix.copy(o.bindMatrix),t.skeleton.bones=i.map(function(e){return s.get(e)}),t.bind(t.skeleton,t.bindMatrix)}),t}function getBoneByName(e,t){for(let n=0,s=getBones(t);n<s.length;n++)if(e===s[n].name)return s[n]}function getBones(e){return Array.isArray(e)?e:e.bones}function getHelperFromSkeleton(e){const t=new SkeletonHelper(e.bones[0]);return t.skeleton=e,t}function parallelTraverse(e,t,n){n(e,t);for(let s=0;s<e.children.length;s++)parallelTraverse(e.children[s],t.children[s],n)}export{retarget,retargetClip,clone,}