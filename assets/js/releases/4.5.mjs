import{animate,createTimeline,onScroll,eases,text,stagger,}from"../modules/anime@4.1.2_esm.js";import detectPlatform from"../modules/detect-browser.mjs";import"../modules/dashjs@5.0.3.esm.min.js";const{outCirc,inCirc}=eases;let mousePosition={x:0,y:0};const prefersReducedMotion=window.matchMedia("prefers-reduced-motion: reduce").matches,saveData=navigator?.connection?.saveData??!1,releaseHeaderBackground=document.querySelector(".release-header-background"),scrollObserver=onScroll({target:".release-header",enter:"top 0%-=64px",leave:"top 100%",onUpdate:()=>{const e=scrollObserver.progress;releaseHeaderBackground.style.transform=`
			translateY(${e*releaseHeaderBackground.getBoundingClientRect().height}px)
			translateZ(-1px)
			scale(2)
		`,releaseHeaderBackground.style.filter=`blur(${inCirc(e)*5}px)`}}),releaseHeaderBackgroundTween=animate(releaseHeaderBackground,{autoplay:scrollObserver,ease:outCirc}),windowHeight=window.innerHeight,elements=[],releaseCardContainers=Array.from(document.querySelectorAll(".release-cards"));for(const e of releaseCardContainers){const t=Array.from(e.querySelectorAll(".release-card")),n=e.querySelector(".release-card:last-of-type");for(const s of t)elements.push({element:s,container:e,isLastOfType:s===n})}const sectionContainers=Array.from(document.querySelectorAll(".section:has(.section-title)"));for(const e of sectionContainers){elements.push({element:e.querySelector(".section-title h3, .section-title h4"),container:e.querySelector(".section-title"),isLastOfType:!0});const t=e.querySelector(".section-links");if(t==null)continue;elements.push({element:t,container:e.querySelector(".section-title"),isLastOfType:!0})}elements.sort((e,t)=>{const n=e.element.getBoundingClientRect(),s=t.element.getBoundingClientRect();return n.top-s.top});for(const e of elements){if(e.element==null)debugger;if(e.element.getBoundingClientRect().top<windowHeight){e.isLastOfType;continue}const t=onScroll({trigger:e.element,enter:{target:"top",container:"bottom"}});animate(e.element,{y:{from:"+=50px"},opacity:{from:0},duration:500,autoplay:t,ease:outCirc,onComplete:()=>{e.isLastOfType&&e.container.classList.remove("overflow-y-hidden")}})}const platformData=detectPlatform(navigator.userAgent,navigator.userAgentData);let platformName="windows";switch(platformData.os){case"mac":case"iphone":case"ipad":platformName="macos";break;case"linux":platformName="linux";break;case"android":platformName="android";break;case"windows":default:break}const releasePlatformContainer=document.querySelector(".release-platform-container");if(releasePlatformContainer!=null){const e=releasePlatformContainer.querySelector(`.release-platform-${platformName}`);e!=null&&e.classList.add("active")}const downloadOther=document.querySelector(".card-download-other");downloadOther!=null&&(downloadOther.textContent="More downloads");const authors=Array.from(document.querySelectorAll("#special-thanks-release-authors .release-card-authors .release-card-author"));let max_prs=0;for(const e of authors)max_prs=Math.max(max_prs,Number(e.dataset.prs));const scales=new Array(5);for(let e=scales.length-1;e>=0;e--)e+1==scales.length?scales[e]=Math.floor(max_prs/2):scales[e]=Math.floor(scales[e+1]/2);for(const e of authors){const t=Number(e.dataset.prs);for(let n=0;n<scales.length;n++){if(t>=scales[n]){if(n+1==scales.length){e.classList.add(`size-${n+1}`);break}continue}if(n===0)break;e.classList.add(`size-${n+1}`);break}}const lazyVideoObserver=new IntersectionObserver((e,t)=>{for(const o of e){if(!o.isIntersecting)continue;const n=o.target,s=n.querySelector(":scope > source");if(s==null)continue;n.classList.remove("lazy"),s.src=s.dataset.src,delete s.dataset.src,n.load(),t.unobserve(n)}}),releaseCardVideoContainers=Array.from(document.querySelectorAll(".release-card-video-container"));for(const s of releaseCardVideoContainers){const t=s.querySelector(":scope > noscript");if(t==null)throw new Error("`.release-card-video-container > noscript` is null");const o=document.implementation.createHTMLDocument();o.write(t.innerHTML);const e=o.body.querySelector(":scope > .release-card-video");if(e==null)throw new Error("`.release-card-video-container > noscript > .release-card-video` is null");e.classList.add("lazy");const n=e.querySelector(":scope > source");if(n==null)throw new Error("`.release-card-video-container > noscript > .release-card-video > source` is null");n.dataset.src=n.src,n.src="",s.insertBefore(e,t),t.remove(),lazyVideoObserver.observe(e)}const linksElement=document.querySelector("#links"),scrollToTopElement=document.querySelector("#scroll-to-top");let scrollToTopTween=null,scrollState="";const showScrollToTop=()=>{if(scrollState==="show")return;scrollState="show",scrollToTopTween!=null&&scrollToTopTween.cancel(),scrollToTopElement.style.display="block",scrollToTopTween=animate(scrollToTopElement,{opacity:{to:1},duration:500})},hideScrollToTop=()=>{if(scrollState==="hide")return;scrollState="hide",scrollToTopTween!=null&&scrollToTopTween.cancel(),scrollToTopTween=animate(scrollToTopElement,{opacity:{to:0},duration:500,onComplete:()=>{scrollToTopElement.style.display="none"}})},scrollToTopObserver=new IntersectionObserver((e)=>{const n=e[0];if(n.isIntersecting)hideScrollToTop();else{const e=linksElement.getBoundingClientRect();e.y>window.innerHeight?hideScrollToTop():showScrollToTop()}});scrollToTopObserver.observe(linksElement);const releaseCardMediaElements=Array.from(document.querySelectorAll(".release-card-media:not(:has(> .release-card-carousel-container))"));for(const t of releaseCardMediaElements){const r=Array.from(t.querySelectorAll("video")),e=t.querySelector(".comparison-range");if(e==null)continue;const n=t.querySelector(".comparison-range-indicator");if(n==null)continue;const s=t.querySelector(".image-comparison-b, .video-comparison-b");if(s==null)continue;const o=()=>{s.style=`--mask-width: ${e.valueAsNumber}%;`},i=()=>{n.style=`left: calc(${e.valueAsNumber}% - (0.25em / 2))`},a=t=>{const n=e.getBoundingClientRect(),s=t.clientX-n.left,a=n.width;e.valueAsNumber=s/a*100;for(const e of r)e.paused&&e.play();o(),i()};e.addEventListener("pointerdown",a),e.addEventListener("pointermove",a),o(),i()}const findNextCarouselElements=(e,t,n=[],s="next")=>{if(s!=="next"&&s!=="previous")throw new Error("Unknown searchType:",s);let i=s==="next"?1:-1,a=null,o=-1;for(const[t,n]of e.entries()){if(n.classList.contains("hidden"))continue;t+i>=e.length?o=0:t+i<0?o=e.length-1:o=t+i;break}if(o===-1)return{left:null,contentCreator:null,right:null};a=e[o];let r=null;o<t.length&&(r=t[o]);let c=null;return o<n.length&&(c=n[o]),{left:a,contentCreator:r,right:c}},releaseCardMediaCarouselElements=Array.from(document.querySelectorAll(".release-card-media:has(> .release-card-carousel-container)"));for(const d of releaseCardMediaCarouselElements){const e=d.querySelector(".release-card-carousel-container"),r=e.classList.contains("release-card-carousel-container--has-comparison"),c=e.querySelector(".release-card-carousel-left");if(c==null)throw new Error("Couldn't find carousel `.release-card-carousel-left` container in the following element:",e);const l=e.querySelector(".release-card-carousel-content-creator");if(l==null)throw new Error("Couldn't find carousel `.release-card-carousel-content-creator` container in the following element:",e);let s=null;if(r&&(s=e.querySelector(".release-card-carousel-right"),s==null))throw new Error("Couldn't find carousel `.release-card-carousel-right` container in the following element:",e);const i=Array.from(c.querySelectorAll(".release-card-carousel-element")),a=Array.from(l.querySelectorAll(".release-card-content-creator"));let o=[];s!=null&&(o=Array.from(s.querySelectorAll(".release-card-carousel-element")));const t=e.querySelector(".release-card-carousel-control--left");t!=null&&(t.classList.remove("hidden"),t.addEventListener("click",t=>{e.dispatchEvent(new CustomEvent("carousel_previous_element"))}),t.addEventListener("keyup",e=>{switch(e.key){case"Enter":case" ":t.click(),e.preventDefault();default:}}),document.addEventListener("keyup",n=>{const s=document.elementFromPoint(mousePosition.x,mousePosition.y);if(!e.contains(s))return;switch(n.key){case"ArrowLeft":t.click(),n.preventDefault();default:}}));const n=e.querySelector(".release-card-carousel-control--right");if(n!=null&&(n.classList.remove("hidden"),n.addEventListener("click",t=>{e.dispatchEvent(new CustomEvent("carousel_next_element"))}),n.addEventListener("keyup",e=>{switch(e.key){case"Enter":case" ":n.click(),e.preventDefault();default:}}),document.addEventListener("keyup",t=>{const s=document.elementFromPoint(mousePosition.x,mousePosition.y);if(!e.contains(s))return;switch(t.key){case"ArrowRight":n.click(),t.preventDefault();default:}})),e.addEventListener("carousel_previous_element",e=>{const t=findNextCarouselElements(i,a,o,"previous");for(const e of i)e===t.left?e.classList.remove("hidden"):e.classList.add("hidden");for(const e of a)e===t.contentCreator?e.classList.remove("hidden"):e.classList.add("hidden");for(const e of o)e===t.right?e.classList.remove("hidden"):e.classList.add("hidden")}),e.addEventListener("carousel_next_element",e=>{const t=findNextCarouselElements(i,a,o,"next");for(const e of i)e===t.left?e.classList.remove("hidden"):e.classList.add("hidden");for(const e of a)e===t.contentCreator?e.classList.remove("hidden"):e.classList.add("hidden");for(const e of o)e===t.right?e.classList.remove("hidden"):e.classList.add("hidden")}),r){const t=e.querySelector(".comparison-range");if(t==null)continue;const n=e.querySelector(".comparison-range-indicator");if(n==null)continue;const r=Array.from(e.querySelectorAll("video")),o=()=>{s.style=`--mask-width: ${t.valueAsNumber}%;`},i=()=>{n.style=`left: calc(${t.valueAsNumber}% - (0.25em / 2))`},a=e=>{const n=t.getBoundingClientRect(),s=e.clientX-n.left,a=n.width;t.valueAsNumber=s/a*100;for(const e of r)e.paused&&e.play();o(),i()};t.addEventListener("pointerdown",a),t.addEventListener("pointermove",a),o(),i()}}const anchors=Array.from(document.querySelector("main .release-container").querySelectorAll("a"));for(const e of anchors){if(e.classList.contains("download-button")&&e.dataset?.external!=="yes")continue;try{const t=new URL(e.href),n=t.protocol===window.location.protocol&&t.host===window.location.host&&t.port===window.location.port&&t.pathname===window.location.pathname&&t.hash.startsWith("#");n||(e.target="_blank")}catch(t){const e=new Error("Error while setting anchor target to blank.");e.cause=t,console.error(e)}}const initBackgroundVideo=()=>{const t="/storage/releases/4.5/video/godot-lander-manifest.mpd",e=dashjs.MediaPlayer().create(),n=document.getElementById("release-header-background-video");e.updateSettings({streaming:{lastBitrateCachingInfo:{enabled:!0,ttl:36e4},lastMediaSettingsCachingInfo:{enabled:!0,ttl:36e4},abr:{autoSwitchBitrate:{audio:!0,video:!0},rules:{throughputRule:{active:!0},bolaRule:{active:!0},insufficientBufferRule:{active:!0},switchHistoryRule:{active:!0},droppedFramesRule:{active:!1},abandonRequestsRule:{active:!0}}},buffer:{fastSwitchEnabled:null,bufferTimeAtTopQuality:30,bufferTimeAtTopQualityLongForm:60,bufferTimeDefault:12,longFormContentDurationThreshold:600,reuseExistingSourceBuffers:!0,stallThreshold:.3,lowLatencyStallThreshold:.3}}}),e.initialize(n,t,!0)};!prefersReducedMotion&&!saveData&&initBackgroundVideo();const intlBlockquote=document.querySelector("#internationalization-live-preview .c-blockquote");if(intlBlockquote==null)throw new Error("`#internationalization-live-preview .c-blockquote` doesn't exist");const intlBlockquoteTextEntries=[{text:"Hello"},{text:"مرحبًا",rtl:!0},{text:"你好"},{text:"Hallo"},{text:"Bonjour"},{text:"Guten tag"},{text:"Halo"},{text:"Dia dhuit"},{text:"Ciao"},{text:"こんにちは"},{text:"안녕하세요"},{text:"سلام",rtl:!0},{text:"Cześć"},{text:"Olá"},{text:"Oi"},{text:"Привет"},{text:"Hola"},{text:"Hallå"},{text:"வணக்கம்"},{text:"Merhaba"},{text:"привіт"}];for(const t of intlBlockquoteTextEntries){const e=document.createElement("p");e.classList.add("entry"),e.textContent=t.text,e.style.direction=t?.rtl?"rtl":"ltr",intlBlockquote.append(e)}const intlBlockquoteEntries=Array.from(intlBlockquote.querySelectorAll("p.entry")).toSorted(()=>Math.random()>.5?1:-1),intlBlockquoteTimeline=createTimeline({loop:!0});for(const e of intlBlockquoteEntries){const{chars:t}=text.split(e,{chars:{wrap:"clip"}}),n=animate(t,{y:[{to:["120%","0%"]},{to:"-120%",delay:prefersReducedMotion?0:750,ease:"in(3)"}],duration:750,ease:"out(3)",delay:prefersReducedMotion?0:stagger(50,{from:"random"}),loop:!1});intlBlockquoteTimeline.sync(n)}intlBlockquoteTimeline.init();const getCSSVariableValue=e=>parseInt(window.getComputedStyle(document.body).getPropertyValue(e)),TEMPORARY_SPAN_2_COL_2="temporary-span-2-col-2",TEMPORARY_SPAN_2_COL_3="temporary-span-2-col-3",TEMPORARY_SPAN_3_COL_3="temporary-span-3-col-3",TEMPORARY_SPAN_CLASSES=[TEMPORARY_SPAN_2_COL_2,TEMPORARY_SPAN_2_COL_3,TEMPORARY_SPAN_3_COL_3],TEMPORARY_SPAN_CLASSES_LIST=TEMPORARY_SPAN_CLASSES.map(e=>`.${e}`).join(", ");let fixGridOrphansAnimationFrame=-1,lastColumns=-1;const toFixedFloat=(e,t)=>parseFloat(e.toFixed(t)),fixGridOrphansProcess=()=>{fixGridOrphansAnimationFrame=-1;const t=getCSSVariableValue("--card-padding"),n=getCSSVariableValue("--one-column-max-width"),s=getCSSVariableValue("--two-columns-max-width"),e=document.body.clientWidth>s?3:document.body.clientWidth>n?2:1;if(e===lastColumns){fixGridOrphansRequestFrame();return}lastColumns=e;const o=Array.from(document.querySelectorAll(TEMPORARY_SPAN_CLASSES_LIST));for(const e of o)e.classList.remove(...TEMPORARY_SPAN_CLASSES);if(e===1){fixGridOrphansRequestFrame();return}for(const s of Array.from(document.querySelectorAll(".release-cards"))){const i=s.clientWidth,o=(i-(e-1)*t)/e,a=o*2+t,r=o*3+t*2,n=new Map;for(const e of s.querySelectorAll(".release-card")){const t=e.getBoundingClientRect();n.has(t.y)?n.get(t.y).push(e):n.set(t.y,[e])}for(const[o,t]of n){if(t.length===e)continue;const s=t.reduce((e,t)=>e+(t.classList.contains("span-3")?3:t.classList.contains("span-2")?2:1),0);if(s===e)continue;if(t.length===2){t[1].classList.add(TEMPORARY_SPAN_2_COL_3);continue}e===3?t[0].classList.add(TEMPORARY_SPAN_3_COL_3):t[0].classList.add(TEMPORARY_SPAN_2_COL_2)}}fixGridOrphansRequestFrame()},fixGridOrphansRequestFrame=()=>{if(fixGridOrphansAnimationFrame!==-1)return;fixGridOrphansAnimationFrame=window.requestAnimationFrame(fixGridOrphansProcess)};fixGridOrphansRequestFrame(),document.addEventListener("mousemove",e=>{mousePosition.x=e.clientX,mousePosition.y=e.clientY})