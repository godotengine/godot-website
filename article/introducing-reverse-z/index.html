<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Godot Engine">
	<meta name="description" content="We are breaking compatibility for some custom shaders. Here is why.">
	<meta name="theme-color" content="#3d8fcc">
	<meta property="og:site_name" content="Godot Engine">
	<meta property="og:url" content="https://godotengine.org/article/introducing-reverse-z/">
	<meta name="twitter:site" content="@godotengine">

	<meta property="og:title" content="Introducing Reverse Z (AKA I'm sorry for breaking your shader)">
	<meta property="og:description" content="We are breaking compatibility for some custom shaders. Here is why.">
	<meta property="og:image" content="https://godotengine.org/storage/blog/covers/introducing-reverse-z.webp">
	<meta property="og:type" content="article">
	<meta name="twitter:card" content="summary_large_image">
	<title>Introducing Reverse Z (AKA I'm sorry for breaking your shader)</title>

	<link rel="alternate" type="application/rss+xml" title="Godot News" href="/rss.xml">
	<link rel="icon" href="/assets/favicon.png" sizes="any">
	<link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
	<link rel="stylesheet" href="/assets/css/main.css?112">
	<link rel="stylesheet" href="/assets/css/tobii.min.css">
	<link rel="preload" as="font" href="/assets/fonts/Montserrat-Bold.woff2" crossorigin>
	<link rel="preload" as="font" href="/assets/fonts/Montserrat-ExtraBold.woff2" crossorigin>
	<link rel="me" href="https://mastodon.gamedev.place/@godotengine">
</head>

<body>
	<input type="checkbox" id="nav_toggle_cb">
<header>
	<div class="container flex align-center">
		<div id="nav_head">
			<a href="/" id="logo-link">
				<img class="nav-logo" src="/assets/logo.svg" width="136" height="48" alt="Godot Engine">
				<img class="nav-logo dark-logo" src="/assets/logo_dark.svg" width="136" height="48" alt="Godot Engine">
			</a>
			<label for="nav_toggle_cb" id="nav_toggle_btn">
				<img src="/assets/icons/hamburger.svg" width="24" height="24" alt="Main menu">
			</label>
		</div>

		<nav id="nav">
			<ul class="left">
				<li><a href="/features/">Features</a></li>
				<li class="only-on-mobile"><a href="/showcase/">Showcase</a></li>
				<li><a href="/blog/">Blog</a></li>
				<li><a href="/community/">Community</a></li>
				<li><a href="/contact/">About</a></li>
				<li><a href="https://godotengine.org/asset-library/asset">Assets</a></li>
			</ul>

			<ul class="right">
				<li><a href="/download/windows/" class="set-os-download-url">Download</a></li>
				<li><a href="https://docs.godotengine.org">Docs</a></li>
				<li><a href="https://docs.godotengine.org/en/stable/community/contributing/index.html">Contribute</a></li>
				
				<li class="fund"><a href="https://fund.godotengine.org">❤&#xFE0E; Donate</a></li>
			</ul>
		</nav>
	</div>
</header>

<main>


<style>
	body {
		background-color: var(--background-color);
	}

	h1 {
		margin-bottom: 8px;
		margin-top: 32px;
	}

	:not(pre)>code {
		background: var(--code-background-color);
		padding: 1px 4px;
		font-size: 0.95em;
		border-radius: 3px;
	}

	pre {
		background: var(--codeblock-background-color);
		color: var(--codeblock-color);
	}

	pre code {
		display: block;
		overflow-x: auto;
		padding: .5em;
	}

	.date-big {
		line-height: 2;
		margin-left: 32px;
	}

	article {
		background-color: var(--base-color);
		box-shadow: 0px 3px 2px 0px rgba(0, 0, 0, 0.15);
	}

	figure {
		margin: 0;
	}

	figure img {
		margin: 0;
	}

	article img,
	article video {
		max-width: 100%;
		height: auto;
		display: block;
		margin: auto;
		margin-top: 16px;
		margin-bottom: 16px;
	}

	article h1 {
		margin-top: 64px;
	}

	article h2,
	article h3,
	article h4 {
		margin-top: 42px;
	}

	.article-info {
		display: flex;
		flex-direction: column;
		gap: 8px;
	}

	.article-metadata {
		display: flex;
		gap: 24px;
		align-items: center;
		font-family: var(--header-font-family);
		margin-bottom: 12px;
	}

	@media (max-width: 900px) {
		.article-metadata {
			flex-direction: column;
			align-items: flex-start;
			gap: 16px;
		}
	}

	.article-author {
		color: var(--base-color-text-subtitle-date);
		font-weight: 700;
		font-size: 18px;
		flex-grow: 1;
		display: flex;
		gap: 12px;
		align-items: center;
	}

	.article-author .avatar {
		border-radius: 100%;
		margin: 0;
	}

	.article-author .by {
		color: var(--base-color-text-subtitle);
	}

	.article-metadata .date {
		color: var(--base-color-text-subtitle-date);
	}

	.article-metadata .date.post-recent-highlight {
		color: var(--post-recent-highlight-color);
		opacity: 0.8;
	}

	.article-metadata .date.post-recent-highlight::after {
		font-size: 80%;
		content: "NEW";
		border: 2px solid var(--post-recent-highlight-color);
		padding: 2px 3px;
		margin-left: 8px;
	}

	.tag.active {
		filter: saturate(0.75);
	}

	@media screen and (min-width: 900px) {
		article .content {
			width: 70%;
			margin: auto;
		}
	}

	@media (max-width: 900px) {
		body {
			background-color: var(--base-color);
		}

		article {
			background-color: transparent;
			box-shadow: none;
		}

		article img:first-child,
		article video:first-child {
			max-width: 100%;
		}
	}
</style>

<link rel="stylesheet" href="/assets/css/highlight.obsidian.min.css">

<div class="container">
	<article class="padded">
		<div class="content article-container">
			<figure class="article-cover">
				

				<img src="/storage/blog/covers/introducing-reverse-z.webp" title=""
					alt=" " class="rounded-lg"
					style="width: 100%; height: auto; background-color: transparent;" />
			</figure>

			<div class="article-info">
				<h1>
					Introducing Reverse Z (AKA I'm sorry for breaking your shader)
				</h1>
				<div class="article-metadata">
					<div class="article-author">
						<span>By: </span>
						
						
							<img class="avatar" width="25" height="25" src="/assets/images/authors/clayjohn.jpg" alt="Clay John" loading="lazy">
						
						<span class="by">Clay John</span>
					</div>
					<span class="date" data-post-date="2024-04-29 13:00:00 +0000"> 29 April 2024</span>
				</div>

				<div class="tags">
					
					<a href="/blog/news">
						<div class="tag active">News</div>
					</a>
					
				</div>
			</div>

			







			<div class="article-body">
				<p>After extensive discussion, we have decided to implement the reverse Z depth buffer technique in Godot 4.3. This is an exciting change as it brings a massive improvement to depth buffer precision at no performance or memory cost. This technique is used everywhere in 3D games these days. In practical terms, it significantly reduces the chances of running into Z-fighting and other depth buffer precision artifacts. NVIDIA has an <a href="https://developer.nvidia.com/content/depth-precision-visualized">excellent article</a> explaining the theory and benefits behind using reverse Z; please read it for more technical information.</p>

<p>I am writing this post because, unfortunately, implementing reverse Z naturally breaks compatibility for some shaders. We try to avoid compatibility breakage as much as possible, but in some cases it is unavoidable, or the benefits of doing so far outweigh the cost. The rendering team felt in this case that the benefits sufficiently outweighed the costs.</p>

<p>We are certain that the vast majority of users will not run into any compatibility breakage. For most people this change is all good with no downside.</p>

<p>You may need to tweak your shaders if you use a custom spatial shader that:</p>

<ul>
  <li>Writes to <code class="language-plaintext highlighter-rouge">POSITION</code> in the vertex processor function</li>
  <li>Writes to <code class="language-plaintext highlighter-rouge">DEPTH</code> in the fragment processor function</li>
  <li>Reads from <code class="language-plaintext highlighter-rouge">depth_texture</code></li>
  <li>Operates in clip space</li>
</ul>

<p>In most cases when working with <code class="language-plaintext highlighter-rouge">POSITION</code>, <code class="language-plaintext highlighter-rouge">DEPTH</code>, or the <code class="language-plaintext highlighter-rouge">depth_texture</code>, you won’t need to make any shader changes as long as you are transforming the values into/out of clip space using the <code class="language-plaintext highlighter-rouge">PROJECTION_MATRIX</code> or the <code class="language-plaintext highlighter-rouge">INV_PROJECTION_MATRIX</code>. In those cases, the transformation is handled for you and your shader will continue to work.</p>

<p>Let’s look at the cases one-by-one to see what sort of shaders will break and how to fix them.</p>

<h3 id="writes-to-position">Writes to <code class="language-plaintext highlighter-rouge">POSITION</code></h3>

<p>When you write to <code class="language-plaintext highlighter-rouge">POSITION</code> in Godot, you are bypassing the built-in vertex transformation and writing a clip space position directly. This can be helpful to optimize a vertex shader, or to achieve certain effects (like having a mesh stay fixed in the camera view). Commonly users wrote the following line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POSITION = vec4(VERTEX, 1.0);
</code></pre></div></div>

<p>This line is even reproduced in our <a href="https://docs.godotengine.org/en/4.2/tutorials/shaders/advanced_postprocessing.html">documentation</a>. It relies on users supplying a QuadMesh with a width and height of 2 to fill the entire screen. The code assumes that:</p>

<ol>
  <li>
    <p>All vertices of the mesh have a Z-coordinate of 0 (which is true for the QuadMesh), and</p>
  </li>
  <li>
    <p>A clip space value of 0 corresponds to the near plane.</p>
  </li>
</ol>

<p>We have broken assumption 2 by flipping the definition of the near plane and the far plane, so this code no longer works. Instead, users need to write:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POSITION = vec4(VERTEX.xy, 1.0, 1.0);
</code></pre></div></div>

<p>And that’s it!</p>

<p>Since this code is used so widely, we are adding a special <a href="https://github.com/godotengine/godot/pull/90587">warning</a> for it so the engine can give you a heads up if your code will potentially break in 4.3.</p>

<p>Importantly, writes to <code class="language-plaintext highlighter-rouge">POSITION</code> will only break if they are writing values in directly in clip space. If you are transforming values from view space using the <code class="language-plaintext highlighter-rouge">PROJECTION_MATRIX</code>, no code changes are necessary. For example, the following code will continue to work:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POSITION = PROJECTION_MATRIX * MODELVIEW_MATRIX * vec4(VERTEX, 1.0);
</code></pre></div></div>

<h3 id="writes-to-depth">Writes to <code class="language-plaintext highlighter-rouge">DEPTH</code></h3>

<p>Writing to <code class="language-plaintext highlighter-rouge">DEPTH</code> comes with the same warnings as writing to <code class="language-plaintext highlighter-rouge">POSITION</code>. If the clip space value comes from transforming a view space value with the <code class="language-plaintext highlighter-rouge">PROJECTION_MATRIX</code>, then no changes are necessary.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// This will continue to work.
vec4 clip_pos = PROJECTION_MATRIX * vec4(VERTEX, 1.0);
clip_pos.xyz /= clip_pos.w;
DEPTH = clip_pos.z;

// This will need to change.
DEPTH = 0.0;  // Needs to change to 1.0.
</code></pre></div></div>

<h3 id="reads-from-depth_texture">Reads from <code class="language-plaintext highlighter-rouge">depth_texture</code></h3>

<p>This is potentially the area where the most changes will be necessary. Like the above two cases, as long as you are doing your operations in another space (e.g. view space), you don’t need to worry. The following very common code (<a href="https://docs.godotengine.org/en/4.2/tutorials/shaders/screen-reading_shaders.html#depth-texture">from the documentation</a>) will continue to work as before:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>float depth = textureLod(depth_texture, SCREEN_UV, 0.0).r;
vec4 upos = INV_PROJECTION_MATRIX * vec4(SCREEN_UV * 2.0 - 1.0, depth, 1.0);
vec3 pixel_position = upos.xyz / upos.w;
</code></pre></div></div>

<p>For example, in the above code, I may be comparing the depth buffer value to my pixel’s depth value. So I could do something like draw a foam outline in a water shader. i.e.:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (VERTEX.z &gt; pixel_position.z) {
    // Do something.
}
</code></pre></div></div>

<p>This code will require no modification. Where users will need to make modifications in their code is if they are doing these operations in clip space. For example, instead of transforming the depth into view space and comparing the position, users could instead transform the vertex position into clip space and compare.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vec4 clip_pos = PROJECTION_MATRIX * vec4(VERTEX, 1.0);
clip_pos.xyz /= clip_pos.w;
float depth = textureLod(depth_texture, SCREEN_UV, 0.0).r;

if (clip_pos &gt; depth) {
    // Do something.
}
</code></pre></div></div>

<p>This case will need to be modified. Particularly, the conditional needs to be flipped to become:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (clip_pos &lt; depth) {
    // Do something.
}
</code></pre></div></div>

<p>This reflects the fact that the near plane is now at a clip space Z position of 1.0 instead of 0.0. Other similar cases will arise. For example, you may instead be looking at the difference between the depth buffer and your vertex position:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>float depth_mask = smoothstep(0.1, 0.3, clip_pos.z - depth);
</code></pre></div></div>

<p>You will have to modify the function manually, either using <code class="language-plaintext highlighter-rouge">depth - clip_pos.z</code> or <code class="language-plaintext highlighter-rouge">abs(clip_pos.z - depth)</code>.</p>

<h3 id="operations-in-clip-space">Operations in clip space</h3>

<p>The above depth buffer operations are an example of the types of operations users might do in clip space. Ultimately, most operations should not be done in clip space as it is a non-linear space (i.e. relative distances will change depending on the camera’s distance to the object). We recommend that, if you are doing operations in clip space (like in the above example), you switch to doing those operations in view space instead. If you know what you are doing and insist on continuing your operations in clip space then:</p>

<ol>
  <li>I’m sorry we broke your shader.</li>
  <li>I trust you know how to fix your shader.</li>
  <li>We promise not to break your shader again by changing the definition of clip space anytime soon.</li>
</ol>

<h3 id="summary">Summary</h3>

<p>We know that some shaders will break with this change and we are sorry to break compatibility in this way. However, we carefully weighed our options and we decided that now was the best time to implement reverse Z. Our other option was to wait until Godot 5.0. We chose not to wait as we intend to continue working on 4.x for many, many years and we anticipate that with all the upgrades coming to the 3D renderer in the coming years, reverse Z will become a necessity for many games. Further, we are continuing to expose more ways to customize rendering, including allowing users to access the raw depth texture outside of shaders using <a href="https://github.com/godotengine/godot/pull/80214">CompositorEffects</a>. Accordingly, the negative impact of compatibility breakage will only get worse as time goes on.</p>

<p>If you run into a situation where your shader breaks and it’s not covered here, please consider making a post on the <a href="https://forum.godotengine.org/">Godot Forum</a>. We can troubleshoot the issue together and leave our notes for other users to find through search engines.</p>

			</div>
		</div>
	</article>
</div>

<link rel="stylesheet" href="/assets/css/anchor-link.css?1">
<link rel="stylesheet" href="/assets/css/article-cards.css?2">
<script src="/assets/js/anchor-link.js"></script>
<script>
	document.addEventListener('DOMContentLoaded', () => {
		// Add icons to easily copy section links.
		window.applyAnchorLinks('.article-body');

		// Add lightbox elements in blog articles for Tobii.
		document.querySelectorAll('.article-cover img, .article-body img').forEach((articleImg) => {
			if (articleImg.classList.contains('lightbox-ignore')) {
				return;
			}

			const lightbox = document.createElement('a');
			lightbox.href = articleImg.src;
			lightbox.classList.add('lightbox');
			lightbox.dataset.group = 'article';
			articleImg.parentNode.appendChild(lightbox);
			lightbox.appendChild(articleImg);
		});
	});
</script>

</main>

<footer>
	<div class="container flex footer-container">
		<div id="copyright">
			<p>
				© 2007-2024 Juan Linietsky, Ariel Manzur and <a
					href="https://github.com/godotengine/godot/blob/master/AUTHORS.md" target="_blank"
					rel="noopener">contributors</a>.<br>
				Hosted by the <a href="https://godot.foundation/" target="_blank" rel="noopener">Godot Foundation</a>.<br>
				Website <a href="https://github.com/godotengine/godot-website" target="_blank" rel="noopener">source code on  GitHub</a>.
			</p>
		</div>
		<div id="sitemap">
			<ul class="sitemap-group">
				<li><strong>Get Godot</strong></li>
				<li><a href="/download/windows/" class="set-os-download-url">Download</a></li>
				<li><a href="/download/archive/">Release Archive</a></li>
				<li><a href="https://editor.godotengine.org/releases/latest/">Web Editor</a></li>
				<li>&nbsp;</li>
				<li><strong>Public Relations</strong></li>
				<li><a href="/blog/">Blog</a></li>
				<li><a href="/community/">Communities and Events</a></li>
				<li><a href="/press/">Press Kit</a></li>
			</ul>
			<ul class="sitemap-group">
				<li><strong>About Godot</strong></li>
				<li><a href="/features/">Features</a></li>
				<li><a href="/showcase/">Showcase</a></li>
				<li><a href="/education/">Education</a></li>
				<li><a href="/license/">License</a></li>
				<li><a href="/code-of-conduct/">Code of Conduct</a></li>
				<li><a href="/privacy-policy/">Privacy Policy</a></li>
				<li><a href="https://fund.godotengine.org">Donate</a></li>
			</ul>
			<ul class="sitemap-group">
				<li><strong>Project Team</strong></li>
				<li><a href="/governance/">Governance</a></li>
				<li><a href="/teams/">Teams</a></li>
				<li>&nbsp;</li>
				<li><strong>Extra Resources</strong></li>
				<li><a href="https://godotengine.org/asset-library/asset">Asset Library</a></li>
				<li><a href="https://docs.godotengine.org">Documentation</a></li>
				<li><a href="https://github.com/godotengine">Code Repository</a></li>
			</ul>
		</div>
		<div id="social" class="dark-desaturate">
			<h4 class="text-right"><a href="/contact/">Contact us</a></h4>
			<div class="flex justify-space-between" style="gap: 3px;">
				<a href="https://github.com/godotengine" target="_blank" rel="noopener">
					<img src="/assets/footer/github_logo.svg" width="32" height="32" alt="GitHub">
				</a>
				<a href="https://mastodon.gamedev.place/@godotengine" target="_blank" rel="noopener">
					<img src="/assets/footer/mastodon_logo.svg" width="32" height="32" alt="Mastodon">
				</a>
				<a href="https://twitter.com/godotengine" target="_blank" rel="noopener">
					<img src="/assets/footer/twitter_logo.svg" width="32" height="32" alt="Twitter">
				</a>
				<a href="https://www.facebook.com/groups/godotengine/" target="_blank" rel="noopener">
					<img src="/assets/footer/facebook_logo.svg" width="32" height="32" alt="Facebook">
				</a>
				<a href="https://www.reddit.com/r/godot" target="_blank" rel="noopener">
					<!-- Zero-width space in the `alt` text to prevent content blockers from blocking the icon -->
					<img src="/assets/footer/reddit_logo.svg" width="32" height="32" alt="Red​dit">
				</a>
				<a href="/rss.xml" target="_blank" rel="noopener">
					<!-- Icon is called `feed` instead of `rss` to prevent content blockers from blocking the icon -->
					<img src="/assets/footer/feed_logo.svg" width="32" height="32" alt="RSS feed">
				</a>
			</div>
		</div>
	</div>
</footer>

<script defer src="/assets/js/tobii.min.js"></script>
<script defer src="/assets/js/highlight.min.js?1"></script>
<script defer src="/assets/js/highlight.gdscript.min.js?1"></script>
<script>
	document.addEventListener('DOMContentLoaded', () => {
		// This needs to be done on page load but also after page changes,
		// in case a code block appears in an article.
		document.querySelectorAll('pre code').forEach((block) => {
			hljs.highlightBlock(block);
		});

		document.querySelectorAll('[data-post-date]').forEach((postDate) => {
			// Highlight post dates that are less than 48 hours old.
			if (Date.parse(postDate.dataset.postDate) > (Date.now() - 1000 * 60 * 60 * 48)) {
				postDate.classList.add("post-recent-highlight");
			};
		});

		// Initialize lightbox.
		new Tobii({
			zoom: false,
		});

		// Update any download link to point to identified user's OS.
		const links = document.querySelectorAll('.set-os-download-url');
		for (let i = 0; i < links.length; i++) {
			const link = links[i];
			let link_slug = 'download';
			if ('version' in link.dataset && link.dataset['version'] === '3') {
				link_slug = 'download/3.x';
			}

			let link_platform = 'windows';
			if (navigator.platform.indexOf('Mac') !== -1) {
				link_platform = 'macos';
			} else if (navigator.platform.indexOf('Linux') !== -1) {
				link_platform = 'linux';
			}

			link.href = `/${link_slug}/${link_platform}/`;
		}
	});
</script>


</body>

</html>
