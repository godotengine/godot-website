<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Godot Engine"><meta name=description content="Because of the big release there have been many GDNative related tasks that needed to be addressed. Apart from that, the month was mostly spent on implementing more 2D items in the renderer as well as working on getting custom shaders running."><meta name=theme-color content="#3d8fcc"><meta property="og:site_name" content="Godot Engine"><meta property="og:url" content="https://godotengine.org/article/gles2-and-gdnative-progress-report-2/"><meta name=twitter:site content="@godotengine"><meta property="og:title" content="GLES2 and GDNative, progress report #2"><meta property="og:description" content="Because of the big release there have been many GDNative related tasks that needed to be addressed. Apart from that, the month was mostly spent on implementing more 2D items in the renderer as well as working on getting custom shaders running."><meta property="og:image" content="https://godotengine.org/storage/app/uploads/public/5a8/20c/237/5a820c237c611332498492.png"><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><title>GLES2 and GDNative, progress report #2</title><link rel=alternate type=application/rss+xml title="Godot News" href=/rss.xml><link rel=icon href=/assets/favicon.png sizes=any><link rel=icon href=/assets/favicon.svg type=image/svg+xml><link rel=stylesheet href=/assets/css/main.css?111><link rel=stylesheet href=/assets/css/tobii.min.css><link rel=preload as=font href=/assets/fonts/Montserrat-Bold.woff2 crossorigin><link rel=preload as=font href=/assets/fonts/Montserrat-ExtraBold.woff2 crossorigin><link rel=me href=https://mastodon.gamedev.place/@godotengine><input type=checkbox id=nav_toggle_cb><header><div class="container flex align-center"><div id=nav_head><a href=/ id=logo-link><img class=nav-logo src=/assets/logo.svg width=136 height=48 alt="Godot Engine">
<img class="nav-logo dark-logo" src=/assets/logo_dark.svg width=136 height=48 alt="Godot Engine"></a>
<label for=nav_toggle_cb id=nav_toggle_btn><img src=/assets/icons/hamburger.svg width=24 height=24 alt="Main menu"></label></div><nav id=nav><ul class=left><li><a href=/features>Features</a><li class=only-on-mobile><a href=/showcase>Showcase</a><li><a href=/blog>Blog</a><li><a href=/community>Community</a><li><a href=/contact>About</a><li><a href=https://godotengine.org/asset-library/asset>Assets</a></ul><ul class=right><li><a href=/download/windows class=set-os-download-url>Download</a><li><a href=https://docs.godotengine.org>Learn</a><li><a href=https://docs.godotengine.org/en/stable/community/contributing/index.html>Contribute</a><li class=fund><a href=https://fund.godotengine.org>❤&#xFE0E; Donate</a></ul></nav></div></header><main><style>body{background-color:var(--background-color)}h1{margin-bottom:8px;margin-top:32px}:not(pre)>code{background:var(--code-background-color);padding:1px 4px;font-size:.95em;border-radius:3px}pre{background:var(--codeblock-background-color);color:var(--codeblock-color)}pre code{display:block;overflow-x:auto;padding:.5em}.date-big{line-height:2;margin-left:32px}article{background-color:var(--base-color);box-shadow:0 3px 2px rgba(0,0,0,.15)}figure{margin:0}figure img{margin:0}article img,article video{max-width:100%;height:auto;display:block;margin:auto;margin-top:16px;margin-bottom:16px}article h1{margin-top:64px}article h2,article h3,article h4{margin-top:42px}.article-info{display:flex;flex-direction:column;gap:8px}.article-metadata{display:flex;gap:24px;align-items:center;font-family:var(--header-font-family);margin-bottom:12px}@media(max-width:900px){.article-metadata{flex-direction:column;align-items:flex-start;gap:16px}}.article-author{color:var(--base-color-text-subtitle-date);font-weight:700;font-size:18px;flex-grow:1;display:flex;gap:12px;align-items:center}.article-author .avatar{border-radius:100%;margin:0}.article-author .by{color:var(--base-color-text-subtitle)}.article-metadata .date{color:var(--base-color-text-subtitle-date)}.article-metadata .date.post-recent-highlight{color:var(--post-recent-highlight-color);opacity:.8}.article-metadata .date.post-recent-highlight::after{font-size:80%;content:"NEW";border:2px solid var(--post-recent-highlight-color);padding:2px 3px;margin-left:8px}.tag.active{filter:saturate(.75)}@media screen and (min-width:900px){article .content{width:70%;margin:auto}}@media(max-width:900px){body{background-color:var(--base-color)}article{background-color:initial;box-shadow:none}article img:first-child,article video:first-child{max-width:100%}}</style><link rel=stylesheet href=/assets/css/highlight.obsidian.min.css><div class=container><article class=padded><div class="content article-container"><figure class=article-cover><img src=/storage/app/uploads/public/5a8/20c/237/5a820c237c611332498492.png title alt=" " class=rounded-lg style=width:100%;height:auto;background-color:initial></figure><div class=article-info><h1>GLES2 and GDNative, progress report #2</h1><div class=article-metadata><div class=article-author><span>By:</span>
<img class=avatar width=25 height=25 src=/assets/images/authors/default_avatar.svg alt=karroffel loading=lazy>
<span class=by>karroffel</span></div><span class=date data-post-date="2018-02-12 21:50:59 +0000">12 February 2018</span></div><div class=tags><a href=/blog/progress-report><div class="tag active">Progress Report</div></a></div></div><div class="card card-warning"><p>This article is from <strong>February 2018</strong>, some of its contents might be outdated and no longer accurate.<br>You can find up-to-date information about the engine in the <a href=https://docs.godotengine.org/en/stable/>official documentation</a>.</div><div class=article-body><h2 id=introduction>Introduction</h2><p>Almost one month has passed since the last <a href=https://godotengine.org/article/gles2-and-gdnative-progress-report-1>progress report</a> and the month of January happens to be the month in which <a href=https://godotengine.org/article/godot-3-0-released>Godot 3.0 got released</a>!<p>Because of the big release there have been many GDNative related tasks that needed to be addressed. Apart from that, the month was mostly spent on implementing more 2D items in the renderer as well as working on getting custom shaders running.<h2 id=roadmap>Roadmap</h2><h4 id=done-january-2018>Done January 2018</h4><ul><li>bring GDNative API into stable state<li>improve C++ bindings<li>add simple C++ GDNative demo<li>add line rendering<li>add ninepatch rendering<li>add polygon and GUI primitive rendering<li>start work on shader compiler<li>add circle rendering</ul><h4 id=planned-february-2018>Planned February 2018</h4><ul><li>meet with other developers at FOSDEM and GodotCon<li>implement more shader features<li>NativeScript 1.1 extension<li>Rust binding guidance<li>load meshes<li>render meshes<li>implement basic PBR<li>directional lights</ul><h2 id=details-about-work-in-january-2018>Details about work in January 2018</h2><h3 id=bring-gdnative-api-into-stable-state>bring GDNative API into stable state</h3><p>With the release of Godot 3.0 being very close, the GDNative C API needed to be revisited one last time before any modifications would need to be done in a backwards-compatible way.<p>As the result of this revisiting a few things have changed in the API, most significant ones being:<ul><li>changing String API to reduce memory allocations<li>adding read and write lock objects for PoolVector types</ul><h3 id=improve-c-bindings>improve C++ bindings</h3><p>The C++ bindings to GDNative make some use of templates to do various things. NativeScript requires, since it’s a C API, that all methods registered to Godot from a library are implemented by <a href=https://github.com/godotengine/godot/blob/e4213e66b2dd8f5a87d8cf5015ac83ba3143279d/modules/gdnative/include/nativescript/godot_nativescript.h#L142-L149>a function with C linkage</a>. The C++ bindings however use classes and instance-methods for increased usability.<p>So one of the use cases for templates is the creation of functions with C linkage at compile that, which wrap the actual C++ method pointer (not to be confused with function pointers…), unwrap the arguments that are passed in as <code class="language-plaintext highlighter-rouge">godot_variant</code>s to the appropriate types and then call the actual C++ method with the associated object. (All of this happens <a href=https://github.com/GodotNativeTools/godot-cpp/blob/7dde412e26315447edf2f46661143082b5becf32/include/core/Godot.hpp#L192-L245>here</a> and <a href=https://github.com/GodotNativeTools/godot-cpp/blob/7dde412e26315447edf2f46661143082b5becf32/include/core/Godot.hpp#L63-L85>here</a>)<p>Previously, only basic Godot types were supported to be used as method parameters, making it harder to pass around and use objects with C++ classes attached to them. A change in the <code class="language-plaintext highlighter-rouge">_ArgCast</code> templates allows each pointer type to construct the object the way it wants, enabling the use of custom classes as parameters.<p>One kind of Object has special semantics in Godot, the <a href=https://github.com/godotengine/godot/blob/e4213e6/core/reference.h#L42-L61><code class="language-plaintext highlighter-rouge">Reference</code></a> class. All classes inheriting from it can be reference counted. This is Godot’s main mechanism for memory management.
To increase or decrease the reference count, the methods <code class="language-plaintext highlighter-rouge">reference()</code> and <code class="language-plaintext highlighter-rouge">unreference()</code> need to be called manually. Since this is bothersome, Godot has its own <a href=https://en.wikipedia.org/wiki/Smart_pointer>smart-pointer</a> type called <a href=https://github.com/godotengine/godot/blob/e4213e6/core/reference.h#L63-L64><code class="language-plaintext highlighter-rouge">Ref</code></a>, which references on copy and automatically dereferences when the smart pointer goes out of scope.<p>This functionality was replicated in the C++ bindings, but the translation from Godot-intern code into the external bindings had some unexpected problems - causing memory leaks.<p>With the work of <a href=https://github.com/Zylann>Zylann</a>, those issues were resolved quickly.<h3 id=add-simple-c-gdnative-demo>add simple C++ GDNative demo</h3><p>Because GDNative is a C API, the minimal example demo to see if things are actually working is <a href=https://github.com/GodotNativeTools/GDNative-demos/tree/386f6571eba1b5a2986660fbbb54ebf2348c0b53/c/SimpleDemo>implemented in C</a>.<p>The GDNative and NativeScript APIs are rather verbose, so many people seemed to wish for a simpler C++ demo. Hence a <a href=https://github.com/GodotNativeTools/GDNative-demos/tree/8b3c2ee96b26b538248556cff9de5b4d2c85fe8d/cpp/SimpleDemo>new demo was added</a>, which does exactly the same as the C demo, but is much simpler.<p>The whole demo pretty much boils down to the following code.<div class="language-cpp highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=k>class</span> <span class=nc>Simple</span> <span class=o>:</span> <span class=k>public</span> <span class=n>godot</span><span class=o>::</span><span class=n>GodotScript</span><span class=o>&lt;</span><span class=n>godot</span><span class=o>::</span><span class=n>Reference</span><span class=o>&gt;</span> <span class=p>{</span>
	<span class=n>GODOT_CLASS</span><span class=p>(</span><span class=n>Simple</span><span class=p>)</span>

	<span class=n>godot</span><span class=o>::</span><span class=n>String</span> <span class=n>data</span><span class=p>;</span>
<span class=nl>public:</span>

	<span class=k>static</span> <span class=kt>void</span> <span class=n>_register_methods</span><span class=p>()</span> <span class=p>{</span>
	    <span class=n>godot</span><span class=o>::</span><span class=n>register_method</span><span class=p>(</span><span class=s>"get_data"</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>Simple</span><span class=o>::</span><span class=n>get_data</span><span class=p>);</span>
	<span class=p>}</span>

	<span class=kt>void</span> <span class=n>_init</span><span class=p>()</span> <span class=p>{</span>
	    <span class=n>data</span> <span class=o>=</span> <span class=s>"Hello World from C++"</span><span class=p>;</span>
	<span class=p>}</span>

	<span class=n>godot</span><span class=o>::</span><span class=n>String</span> <span class=n>get_data</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
	    <span class=k>return</span> <span class=n>data</span><span class=p>;</span>
	<span class=p>}</span>
<span class=p>};</span>
</code></pre></div></div><h3 id=add-line-rendering>add line rendering</h3><p>As mentioned in the <a href=https://godotengine.org/article/gles2-and-gdnative-progress-report-1>last progress report</a>, 2D rendering is done by processing a series of “items” that tell the rendering backend which kind of 2D element should be rendered and in what way.<p>There were still quite a few item rendering implementations missing, one of them is basic line rendering.<p>The most obvious use case: underlining text.<p><img src=/storage/app/uploads/public/5a8/094/a77/5a8094a7745a6874916835.png alt="Screenshot from 2018-01-03 18-25-40.png"><p>2D Editor gizmos are another place where simple lines are used.<h3 id=add-ninepatch-rendering>add ninepatch rendering</h3><p>As seen in the previous screenshot, many UI elements looked “washed out” and stretched. The rendering command used by such an item is the <a href=https://github.com/karroffel/godot/blob/c82c9f73fc7f9880678482769f6c3b13143ef737/servers/visual/rasterizer.h#L700-L715><code class="language-plaintext highlighter-rouge">CommandNinePatch</code></a>.<p>A Ninepatch element is a (usually textured) rectangle that has a fixed margin for the borders. That’s how the borders of a button look equally smooth when resizing the button - only the center gets freely scaled, the corners stay the same and the other parts of the border get only scaled in one dimension.<p>It’s called Ninepatch because the rectangle gets split into nine sub-rectangles.<p>The GLES3 renderer only renders a single rectangle but feeds the fragment shader with the needed margin information. The fragment shader then calculates the associated UV coordinate for each fragment. The same approach shouldn’t be used in GLES2, since some drivers work a lot better if no dependent texture reads are performed. (layman explanation: the UVs of a texture for a fragment should be known before the fragment shader actually executes)<p>Previously Godot issued 8 or 9 render calls for each sub-rectangle (8 if the center doesn’t get rendered).
In the new GLES2 backened I decided to use a vertex + index array buffer instead to reduce the number of draw calls. For each vertex the fitting UVs get calculated before the draw call. Because of some stupid typos I had a hard time getting this right, but at least I got a nice UV-debug screenshot out of it.<p><img src=/storage/app/uploads/public/5a8/094/c34/5a8094c3400d6076419598.png alt="Screenshot from 2018-01-04 14-46-14.png"><p>Once this was all working, the elements rendered correctly.<p><img src=/storage/app/uploads/public/5a8/1e7/ec9/5a81e7ec9e5cf087690313.png alt="Screenshot from 2018-01-04 14-53-15.png"><p>A nice consequence of using a element array buffer for rendering instead of different draw calls is that the center rect rendering can be <a href=https://github.com/karroffel/godot/blob/c82c9f73fc7f9880678482769f6c3b13143ef737/drivers/gles2/rasterizer_canvas_gles2.cpp#L502>disabled and enabled</a> with very little overhead.<p><img src=/storage/app/uploads/public/5a8/1e8/0ad/5a81e80ad8af5616140605.png alt="Screenshot from 2018-01-04 15-08-19.png"><h3 id=add-polygon-and-gui-primitive-rendering>add polygon and GUI primitive rendering</h3><p>Even with Ninepatch elements rendering the Godot editor didn’t really look like it should yet.<p><img src=/storage/app/uploads/public/5a8/1e8/c86/5a81e8c864a2c465899325.png alt="Screenshot from 2018-01-03 13-31-29.png"><p>This is because the editor uses <code class="language-plaintext highlighter-rouge">Item</code>s that use <a href=https://github.com/karroffel/godot/blob/d0211f137464614e05d2dc590b5ad9b6ab5ae674/drivers/gles2/rasterizer_canvas_gles2.cpp#L647><code class="language-plaintext highlighter-rouge">CommandPrimitive</code> commands</a>, which can be used to draw lines, triangles or rectangles with easy to set up custom UVs and colors.<p>With that done, the editor almost rendered correctly, except for some incorrect clipping. (which got fixed shortly after this screenshot got taken)<p><img src=/storage/app/uploads/public/5a8/1e8/ef9/5a81e8ef9d35f812103217.png alt="Screenshot from 2018-01-17 14-24-38.png"><h3 id=start-work-on-shader-compiler>start work on shader compiler</h3><p>As written about in a past dev-blog, the Godot <a href=https://godotengine.org/article/making-shaders-more-accessible>shader language got reworked completely</a> for the 3.0 release, meaning that the new GLES2 renderer needs to support that language as well.<p>This is done by using the Godot built-in shader parser and compiler which outputs an <a href=https://en.wikipedia.org/wiki/Abstract_syntax_tree>abstract syntax tree (AST)</a> which can be used for further processing.<p>To support the Godot shader lanuage, the abstract syntax tree needs to be translated into the appropriate target language, in this case GLSL ES 2.0. This is done in the <a href=https://github.com/karroffel/godot/blob/37208c890337894519cf1d1e943a5c381f79dcc0/drivers/gles2/shader_compiler_gles2.h#L40><code class="language-plaintext highlighter-rouge">ShaderCompilerGLES2</code> class</a>.<p>The <a href=https://github.com/karroffel/godot/blob/37208c890337894519cf1d1e943a5c381f79dcc0/drivers/gles2/shader_compiler_gles2.cpp#L268><code class="language-plaintext highlighter-rouge">_dump_node_code</code></a> method is used to output a String for each kind of node in the AST. Recursively, this method is used to generate the GLSL code for the whole shader.<p>Because GLSL ES 2.0 is more limited than GLSL ES 3.0, some features need workarounds or just won’t be supported.<p>For example, unsigned integers are not supported in GLSL ES 2.0, so as a workaround they will be converted to signed ints.<p>Many functions supported by GLSL ES 3.0 can’t be used, such as the <code class="language-plaintext highlighter-rouge">inverse()</code> function for matrices, so either they will have to be re-implemented manually in code (without possible hardware support) or be plainly not supported at all, but this is still up for discussion.<p>Custom shaders are still in an early stage, but they already work inside the editor and in games and support hot-reloading just like with the GLES3 backend.<p><img src=/storage/app/uploads/public/5a8/1e9/334/5a81e933483e3203789438.png alt="Screenshot from 2018-01-19 19-28-39.png"><h3 id=add-circle-rendering>add circle rendering</h3><p>One of the last few item command types unimplemented for 2D rendering was the <code class="language-plaintext highlighter-rouge">CommandCircle</code>. While the initial implementation had a fatal bug, it helped uncover a more hidden bug that caused problems in the editor UI later on.<h2 id=future>Future</h2><p>The big milestone of basic 3D rendering is still ahead and I’m very excited to get my hands dirty. A few things in the 2D rendering still need to be implemented, but overall the 2D experience should be pretty decent by now.<h2 id=seeing-the-code>Seeing the code</h2><p>If you are interested in the GLES2 related code, you can see all the commits in my <a href=https://github.com/karroffel/godot/tree/gles2>fork</a> on GitHub.</div></div></article></div><link rel=stylesheet href=/assets/css/anchor-link.css?1><link rel=stylesheet href=/assets/css/article-cards.css?2><script src=/assets/js/anchor-link.js></script>
<script>document.addEventListener('DOMContentLoaded',()=>{window.applyAnchorLinks('.article-body'),document.querySelectorAll('.article-cover img, .article-body img').forEach(b=>{if(b.classList.contains('lightbox-ignore'))return;const a=document.createElement('a');a.href=b.src,a.classList.add('lightbox'),a.dataset.group='article',b.parentNode.appendChild(a),a.appendChild(b)})})</script></main><footer><div class="container flex footer-container"><div id=copyright><p>© 2007-2024 Juan Linietsky, Ariel Manzur and <a href=https://github.com/godotengine/godot/blob/master/AUTHORS.md target=_blank rel=noopener>contributors</a>.<br>Hosted by the <a href=https://godot.foundation/ target=_blank rel=noopener>Godot Foundation</a>.<br>Website <a href=https://github.com/godotengine/godot-website target=_blank rel=noopener>source code on GitHub</a>.</div><div id=sitemap><ul class=sitemap-group><li><strong>Get Godot</strong><li><a href=/download/windows class=set-os-download-url>Download</a><li><a href=https://editor.godotengine.org/releases/latest/>Web Editor</a><li>&nbsp;<li><strong>Public Relations</strong><li><a href=/blog>Blog</a><li><a href=/community>Communities and Events</a><li><a href=/press>Press Kit</a></ul><ul class=sitemap-group><li><strong>About Godot</strong><li><a href=/features>Features</a><li><a href=/showcase>Showcase</a><li><a href=/education>Education</a><li><a href=/license>License</a><li><a href=/code-of-conduct>Code of Conduct</a><li><a href=/privacy-policy>Privacy Policy</a><li><a href=https://fund.godotengine.org>Donate</a></ul><ul class=sitemap-group><li><strong>Project Team</strong><li><a href=/governance>Governance</a><li><a href=/teams>Teams</a><li>&nbsp;<li><strong>Extra Resources</strong><li><a href=/asset-library/asset>Asset Library</a><li><a href=https://docs.godotengine.org>Documentation</a><li><a href=https://github.com/godotengine>Code Repository</a></ul></div><div id=social class=dark-desaturate><h4 class=text-right><a href=/contact>Contact us</a></h4><div class="flex justify-space-between" style=gap:3px><a href=https://github.com/godotengine target=_blank rel=noopener><img src=/assets/footer/github_logo.svg width=32 height=32 alt=GitHub></a>
<a href=https://mastodon.gamedev.place/@godotengine target=_blank rel=noopener><img src=/assets/footer/mastodon_logo.svg width=32 height=32 alt=Mastodon></a>
<a href=https://twitter.com/godotengine target=_blank rel=noopener><img src=/assets/footer/twitter_logo.svg width=32 height=32 alt=Twitter></a>
<a href=https://www.facebook.com/groups/godotengine/ target=_blank rel=noopener><img src=/assets/footer/facebook_logo.svg width=32 height=32 alt=Facebook></a>
<a href=https://www.reddit.com/r/godot target=_blank rel=noopener><img src=/assets/footer/reddit_logo.svg width=32 height=32 alt=Red​dit></a>
<a href=/rss.xml target=_blank rel=noopener><img src=/assets/footer/feed_logo.svg width=32 height=32 alt="RSS feed"></a></div></div></div></footer><script defer src=/assets/js/tobii.min.js></script>
<script defer src=/assets/js/highlight.min.js?1></script>
<script defer src=/assets/js/highlight.gdscript.min.js?1></script>
<script>document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('pre code').forEach(a=>{hljs.highlightBlock(a)}),document.querySelectorAll('[data-post-date]').forEach(a=>{Date.parse(a.dataset.postDate)>Date.now()-1e3*60*60*48&&a.classList.add("post-recent-highlight")}),new Tobii({zoom:!1});const a=document.querySelectorAll('.set-os-download-url');for(let b=0;b<a.length;b++){const c=a[b];let e='download';'version'in c.dataset&&c.dataset.version==='3'&&(e='download/3.x');let d='windows';navigator.platform.indexOf('Mac')!==-1?d='macos':navigator.platform.indexOf('Linux')!==-1&&(d='linux'),c.href=`/${e}/${d}`}})</script>