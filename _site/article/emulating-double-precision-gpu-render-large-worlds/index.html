<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Godot Engine"><meta name=description content="One of the problems with developing games with large game worlds is that objects start to jitter and teleport around as you move away from the world origin. This post is about how we overcame one challenge in particular and what we did."><meta name=theme-color content="#3d8fcc"><meta property="og:site_name" content="Godot Engine"><meta property="og:url" content="https://godotengine.org/article/emulating-double-precision-gpu-render-large-worlds/"><meta name=twitter:site content="@godotengine"><meta property="og:title" content="Emulating Double Precision on the GPU to Render Large Worlds"><meta property="og:description" content="One of the problems with developing games with large game worlds is that objects start to jitter and teleport around as you move away from the world origin. This post is about how we overcame one challenge in particular and what we did."><meta property="og:image" content="https://godotengine.org/storage/app/uploads/public/634/d8d/43e/634d8d43e5bd4838492470.png"><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><title>Emulating Double Precision on the GPU to Render Large Worlds</title><link rel=alternate type=application/rss+xml title="Godot News" href=/rss.xml><link rel=icon href=/assets/favicon.png sizes=any><link rel=icon href=/assets/favicon.svg type=image/svg+xml><link rel=stylesheet href=/assets/css/main.css?111><link rel=stylesheet href=/assets/css/tobii.min.css><link rel=preload as=font href=/assets/fonts/Montserrat-Bold.woff2 crossorigin><link rel=preload as=font href=/assets/fonts/Montserrat-ExtraBold.woff2 crossorigin><link rel=me href=https://mastodon.gamedev.place/@godotengine><input type=checkbox id=nav_toggle_cb><header><div class="container flex align-center"><div id=nav_head><a href=/ id=logo-link><img class=nav-logo src=/assets/logo.svg width=136 height=48 alt="Godot Engine">
<img class="nav-logo dark-logo" src=/assets/logo_dark.svg width=136 height=48 alt="Godot Engine"></a>
<label for=nav_toggle_cb id=nav_toggle_btn><img src=/assets/icons/hamburger.svg width=24 height=24 alt="Main menu"></label></div><nav id=nav><ul class=left><li><a href=/features>Features</a><li class=only-on-mobile><a href=/showcase>Showcase</a><li><a href=/blog>Blog</a><li><a href=/community>Community</a><li><a href=/contact>About</a><li><a href=https://godotengine.org/asset-library/asset>Assets</a></ul><ul class=right><li><a href=/download/windows class=set-os-download-url>Download</a><li><a href=https://docs.godotengine.org>Learn</a><li><a href=https://docs.godotengine.org/en/stable/community/contributing/index.html>Contribute</a><li class=fund><a href=https://fund.godotengine.org>❤&#xFE0E; Donate</a></ul></nav></div></header><main><style>body{background-color:var(--background-color)}h1{margin-bottom:8px;margin-top:32px}:not(pre)>code{background:var(--code-background-color);padding:1px 4px;font-size:.95em;border-radius:3px}pre{background:var(--codeblock-background-color);color:var(--codeblock-color)}pre code{display:block;overflow-x:auto;padding:.5em}.date-big{line-height:2;margin-left:32px}article{background-color:var(--base-color);box-shadow:0 3px 2px rgba(0,0,0,.15)}figure{margin:0}figure img{margin:0}article img,article video{max-width:100%;height:auto;display:block;margin:auto;margin-top:16px;margin-bottom:16px}article h1{margin-top:64px}article h2,article h3,article h4{margin-top:42px}.article-info{display:flex;flex-direction:column;gap:8px}.article-metadata{display:flex;gap:24px;align-items:center;font-family:var(--header-font-family);margin-bottom:12px}@media(max-width:900px){.article-metadata{flex-direction:column;align-items:flex-start;gap:16px}}.article-author{color:var(--base-color-text-subtitle-date);font-weight:700;font-size:18px;flex-grow:1;display:flex;gap:12px;align-items:center}.article-author .avatar{border-radius:100%;margin:0}.article-author .by{color:var(--base-color-text-subtitle)}.article-metadata .date{color:var(--base-color-text-subtitle-date)}.article-metadata .date.post-recent-highlight{color:var(--post-recent-highlight-color);opacity:.8}.article-metadata .date.post-recent-highlight::after{font-size:80%;content:"NEW";border:2px solid var(--post-recent-highlight-color);padding:2px 3px;margin-left:8px}.tag.active{filter:saturate(.75)}@media screen and (min-width:900px){article .content{width:70%;margin:auto}}@media(max-width:900px){body{background-color:var(--base-color)}article{background-color:initial;box-shadow:none}article img:first-child,article video:first-child{max-width:100%}}</style><link rel=stylesheet href=/assets/css/highlight.obsidian.min.css><div class=container><article class=padded><div class="content article-container"><figure class=article-cover><img src=/storage/app/uploads/public/634/d8d/43e/634d8d43e5bd4838492470.png title alt=" " class=rounded-lg style=width:100%;height:auto;background-color:initial></figure><div class=article-info><h1>Emulating Double Precision on the GPU to Render Large Worlds</h1><div class=article-metadata><div class=article-author><span>By:</span>
<img class=avatar width=25 height=25 src=/assets/images/authors/clayjohn.jpg alt="Clay John" loading=lazy>
<span class=by>Clay John</span></div><span class=date data-post-date="2022-10-17 17:31:04 +0000">17 October 2022</span></div><div class=tags><a href=/blog/progress-report><div class="tag active">Progress Report</div></a></div></div><div class="card card-warning"><p>This article is from <strong>October 2022</strong>, some of its contents might be outdated and no longer accurate.<br>You can find up-to-date information about the engine in the <a href=https://docs.godotengine.org/en/stable/>official documentation</a>.</div><div class=article-body><p>One of the problems with developing games with large game worlds is that objects start to jitter and teleport around as you move away from the world origin. This post is about how we overcame one challenge in particular and what we did.<h3 id=the-problem>The Problem</h3><p>By default Godot uses single-precision floating point numbers to store things like object positions. While GDScript typically allows users to do user-space calculations with double precision, those calculations get truncated as soon as they are stored in Godot internal objects (like Vector3’s).<p>This has been a problem for users who want to do things like make games that take place in a to-scale solar system. Users quickly hit floating point precision errors and noticed that movement becomes jittery and objects become scattered.<p>As an example, take a look at this simple scene, we have a bunch of Godot’s scattered randomly and a person running back and forth across the screen.</p><video autoplay loop muted>
<source src=/storage/app/media/4.0/Doubles-on-GPU/origin.mp4?1 type=video/mp4></video><p><em>The character asset and animation are from GDQuest’s “godot-3d-mannequin” <a href=https://github.com/GDQuest/godot-3d-mannequin>project</a> and the ground texture is from Kenney’s “Prototype Textures” <a href=https://www.kenney.nl/assets/prototype-textures>bundle</a>.</em><p>Close to the scene origin this looks totally fine, but once we move this same scene 10,000 kilometers away something terrible happens. The Godots clump together and the character teleports from point to point. The diameter of the earth is 12,742 km for reference.</p><video autoplay loop muted>
<source src=/storage/app/media/4.0/Doubles-on-GPU/single.mp4?1 type=video/mp4></video><p>10,000 km is 10 million units away from the origin. At 10 million units we have about <a href=https://blog.demofox.org/2017/11/21/>1 unit of precision</a>. That means that there is about 1 meter between each position our Vector3 can store. As you can see in the video above, the clumps are centered on each meter. At 1,000 km we still only have 6.25 cm of precision, which is still not enough for even a simple scene like this.<h3 id=the-solution>The Solution</h3><p>I said above that the problem came from using single-precision in Godot’s internal classes, so the solution should be to use double precision instead. Right?<p>In Godot 4.0 we introduced the ability to compile the engine with double precision floats instead so that all these calculations happen with much higher precision.<p>Let’s switch to a doubles build and see what happens to our scene.</p><video autoplay loop muted>
<source src=/storage/app/media/4.0/Doubles-on-GPU/doubles-without-emulation.mp4?1 type=video/mp4></video><p>Despite all our calculations using fancy double-precision floats, this looks the exact same. What is going on?<p>What is happening here is that the positions are being downcast into single-precision floats before being sent to the GPU for rendering. So on the GPU we are still using single-precision and the end result as far as rendering goes is the same as if we were using single-precision.<p>The solution should be easy, let’s just use doubles in all of our shaders!<h3 id=doubles-in-shaders>Doubles in Shaders</h3><p>First of all, we don’t need <em>all</em> calculations to be in doubles, most of the work done by the GPU only requires single-precision floats. Additionally, GPUs still pay a performance premium when using doubles. So we can restrict our use of doubles to only those operations that need to be in doubles.<p>We actually only need doubles in the calculation of our <code class="language-plaintext highlighter-rouge">MODELVIEW_MATRIX</code>.<p>As a reminder, the <code class="language-plaintext highlighter-rouge">MODELVIEW_MATRIX</code> combines two operations:<ol><li>The transformation from object space to world space, and<li>The transformation from world space to camera space</ol><p>Both of these operations need double precision because we are using a large world. We don’t need double precision in object space or camera space because our models are not large and nothing is very far from the camera. The rest of the shader is in camera space, so we don’t need the extra precision.<p>The <code class="language-plaintext highlighter-rouge">MODELVIEW_MATRIX</code> is assembled in the vertex shader by combining the object’s <code class="language-plaintext highlighter-rouge">MODEL_MATRIX</code> and the camera’s <code class="language-plaintext highlighter-rouge">VIEW_MATRIX</code>.<p><strong><em>Can we get away with just passing those two matrices in as doubles?</em></strong><p><strong>NO</strong><p>For starters, Metal (the graphics API used on all Apple devices) doesn’t support using doubles in shaders, so this wouldn’t work on Apple devices.<p><strong><em>How about we just don’t support this on Apple devices?</em></strong><p><strong>NO</strong><p>Many non-Apple devices still struggle with double precision on the GPU. For example, when running on the Intel integrated graphics GPU on my laptop, Godot crashes whenever a shader using double precision is used.<p><strong><em>Okay, how about we restrict this to dedicated GPUs only?</em></strong><p><strong>NO</strong><p>Restricting this feature to dedicated GPUs is not suitable as it leaves our user base in a lurch. Typical Godot users want to create a game on their hardware and trust that the game will work on most devices. We try to avoid features that come with a long list of exceptions. Further, we would also end up adding significant complexibility to user-space shaders. Users would have to reason about whether the built-in <code class="language-plaintext highlighter-rouge">MODEL_MATRIX</code> and <code class="language-plaintext highlighter-rouge">VIEW_MATRIX</code> are exposed as doubles or floats.<p>In developing Godot we aim for a user experience where things “just work”. At times this involves making difficult judgment calls with respect to performance/usability tradeoffs. This was a case where we just can’t accept a tradeoff that leaves the feature useless to a significant portion of users.<p>So in the end, we can’t simply “turn” on doubles and have everything magically work. But perhaps we can still get things to “just work” another way.<h3 id=the-real-solution>The Real Solution</h3><p>The solution we ultimately went with was Juan’s (reduz) idea. He noted that:<ol><li>We don’t need doubles to do an operation with high precision, instead we can emulate double precision using two-single precision floating point numbers, and<li>We don’t have to calculate the full <code class="language-plaintext highlighter-rouge">MODELVIEW_MATRIX</code> in double precision, we can separate out the rotation/scale transform from the translation transform and only do the translation in double precision.</ol><p><a href=http://andrewthall.org/papers/df64_qf128.pdf>Smarter people</a> than me have already worked out how to do many ordinary operations in near double precision using just a pair of single precision floats. The same basic trick can even be used to create arbitrary precision out of floats or doubles. For example, libraries like <a href=https://github.com/gcc-mirror/gcc/tree/master/libquadmath>LibQuadMath</a> emulate 128 bits of precision using two doubles.<p><strong><em>So how does it work?</em></strong><p>First, outside of the shader we split the double into two floats like so:<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>float some_float1 = float(some_double); // This truncates the double to the nearest float.

// The second float is the difference between double and the truncated value.
float some_float2 = float(some_double - double(some_float1));
</code></pre></div></div><p>This relies on the fact that doubles are a superset of floats. I.e. all floats can be converted to doubles without losing precision. Because the second float is much closer to 0, it has way more precision than the first float and together they are pretty close to the original double.<p>Since we only need this for the translation operation, we just have to pass in an extra <code class="language-plaintext highlighter-rouge">Vector3</code> with the camera matrix and an extra <code class="language-plaintext highlighter-rouge">Vector3</code> with the model matrix. Then, when doing the model to camera space transformation instead of calculating the <code class="language-plaintext highlighter-rouge">MODELVIEW_MATRIX</code>, we separate the transformation into individual components and do the rotation/scale separately from the translation.<p>With this added, the scene looks the same as it did at the world origin.</p><video autoplay loop muted>
<source src=/storage/app/media/4.0/Doubles-on-GPU/double-emulated.mp4?1 type=video/mp4></video><p><strong><em>Are we done?</em></strong><p>Yes, this is the solution we settled on and we are happy with the tradeoffs we ended up with. This solution should work on all our supported hardware and should only reduce performance by a small amount. However, there are a couple limitations:<ol><li>It doesn’t work with the <code class="language-plaintext highlighter-rouge">skip_vertex_transform</code> render mode: In other words, users have to use the default path where Godot handles your model to view space transformation,<li>Users can’t do shader math in world space: User shaders will still be limited by single-precision floating point, so world space calculations will still be subject to low-precision artifacts,<li>This only applies to precision issues from object positions. In other words, it won’t fix your earth-sized sphere, for model vertex positions, you still need to work around single-precision floating point limitations.</ol><p>Overall, we are quite happy with how this solution turned out. We think it is the closest to “just works” that we can get.<p>Note: This change has already been merged into the engine, however it is only available in the “doubles” version of the engine, so to take advantage of it, you will still have to build the engine yourself using the compile flag <code class="language-plaintext highlighter-rouge">precision=double</code> (formerly <code class="language-plaintext highlighter-rouge">float=64</code>).<h2 id=support>Support</h2><p>Godot is a non-profit, open source game engine developed by hundreds of contributors on their free time, and a handful of part or full-time developers, hired thanks to donations from the Godot community. A big thankyou to everyone who has contributed their time or financial support to the project!<p>If you’d like to support the project financially and help us secure our future hires, you can do so on <a href=https://www.patreon.com/godotengine>Patreon</a> or <a href=https://godotengine.org/donate>PayPal</a>.</div></div></article></div><link rel=stylesheet href=/assets/css/anchor-link.css?1><link rel=stylesheet href=/assets/css/article-cards.css?2><script src=/assets/js/anchor-link.js></script>
<script>document.addEventListener('DOMContentLoaded',()=>{window.applyAnchorLinks('.article-body'),document.querySelectorAll('.article-cover img, .article-body img').forEach(b=>{if(b.classList.contains('lightbox-ignore'))return;const a=document.createElement('a');a.href=b.src,a.classList.add('lightbox'),a.dataset.group='article',b.parentNode.appendChild(a),a.appendChild(b)})})</script></main><footer><div class="container flex footer-container"><div id=copyright><p>© 2007-2024 Juan Linietsky, Ariel Manzur and <a href=https://github.com/godotengine/godot/blob/master/AUTHORS.md target=_blank rel=noopener>contributors</a>.<br>Hosted by the <a href=https://godot.foundation/ target=_blank rel=noopener>Godot Foundation</a>.<br>Website <a href=https://github.com/godotengine/godot-website target=_blank rel=noopener>source code on GitHub</a>.</div><div id=sitemap><ul class=sitemap-group><li><strong>Get Godot</strong><li><a href=/download/windows class=set-os-download-url>Download</a><li><a href=https://editor.godotengine.org/releases/latest/>Web Editor</a><li>&nbsp;<li><strong>Public Relations</strong><li><a href=/blog>Blog</a><li><a href=/community>Communities and Events</a><li><a href=/press>Press Kit</a></ul><ul class=sitemap-group><li><strong>About Godot</strong><li><a href=/features>Features</a><li><a href=/showcase>Showcase</a><li><a href=/education>Education</a><li><a href=/license>License</a><li><a href=/code-of-conduct>Code of Conduct</a><li><a href=/privacy-policy>Privacy Policy</a><li><a href=https://fund.godotengine.org>Donate</a></ul><ul class=sitemap-group><li><strong>Project Team</strong><li><a href=/governance>Governance</a><li><a href=/teams>Teams</a><li>&nbsp;<li><strong>Extra Resources</strong><li><a href=/asset-library/asset>Asset Library</a><li><a href=https://docs.godotengine.org>Documentation</a><li><a href=https://github.com/godotengine>Code Repository</a></ul></div><div id=social class=dark-desaturate><h4 class=text-right><a href=/contact>Contact us</a></h4><div class="flex justify-space-between" style=gap:3px><a href=https://github.com/godotengine target=_blank rel=noopener><img src=/assets/footer/github_logo.svg width=32 height=32 alt=GitHub></a>
<a href=https://mastodon.gamedev.place/@godotengine target=_blank rel=noopener><img src=/assets/footer/mastodon_logo.svg width=32 height=32 alt=Mastodon></a>
<a href=https://twitter.com/godotengine target=_blank rel=noopener><img src=/assets/footer/twitter_logo.svg width=32 height=32 alt=Twitter></a>
<a href=https://www.facebook.com/groups/godotengine/ target=_blank rel=noopener><img src=/assets/footer/facebook_logo.svg width=32 height=32 alt=Facebook></a>
<a href=https://www.reddit.com/r/godot target=_blank rel=noopener><img src=/assets/footer/reddit_logo.svg width=32 height=32 alt=Red​dit></a>
<a href=/rss.xml target=_blank rel=noopener><img src=/assets/footer/feed_logo.svg width=32 height=32 alt="RSS feed"></a></div></div></div></footer><script defer src=/assets/js/tobii.min.js></script>
<script defer src=/assets/js/highlight.min.js?1></script>
<script defer src=/assets/js/highlight.gdscript.min.js?1></script>
<script>document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('pre code').forEach(a=>{hljs.highlightBlock(a)}),document.querySelectorAll('[data-post-date]').forEach(a=>{Date.parse(a.dataset.postDate)>Date.now()-1e3*60*60*48&&a.classList.add("post-recent-highlight")}),new Tobii({zoom:!1});const a=document.querySelectorAll('.set-os-download-url');for(let b=0;b<a.length;b++){const c=a[b];let e='download';'version'in c.dataset&&c.dataset.version==='3'&&(e='download/3.x');let d='windows';navigator.platform.indexOf('Mac')!==-1?d='macos':navigator.platform.indexOf('Linux')!==-1&&(d='linux'),c.href=`/${e}/${d}`}})</script>