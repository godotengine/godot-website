<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Godot Engine"><meta name=description content="The long-awaited first post about the multiplayer replication system in development for Godot 4.0 is here! Check out the design goals, concepts, initial prototype, and as always, stay tuned for more!"><meta name=theme-color content="#3d8fcc"><meta property="og:site_name" content="Godot Engine"><meta property="og:url" content="https://godotengine.org/article/multiplayer-changes-godot-4-0-report-4/"><meta name=twitter:site content="@godotengine"><meta property="og:title" content="Multiplayer in Godot 4.0: Scene Replication (part 1)"><meta property="og:description" content="The long-awaited first post about the multiplayer replication system in development for Godot 4.0 is here! Check out the design goals, concepts, initial prototype, and as always, stay tuned for more!"><meta property="og:image" content="https://godotengine.org/storage/app/uploads/public/61a/27f/881/61a27f8816a4e934017559.png"><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><title>Multiplayer in Godot 4.0: Scene Replication (part 1)</title><link rel=alternate type=application/rss+xml title="Godot News" href=/rss.xml><link rel=icon href=/assets/favicon.png sizes=any><link rel=icon href=/assets/favicon.svg type=image/svg+xml><link rel=stylesheet href=/assets/css/main.css?111><link rel=stylesheet href=/assets/css/tobii.min.css><link rel=preload as=font href=/assets/fonts/Montserrat-Bold.woff2 crossorigin><link rel=preload as=font href=/assets/fonts/Montserrat-ExtraBold.woff2 crossorigin><link rel=me href=https://mastodon.gamedev.place/@godotengine><input type=checkbox id=nav_toggle_cb><header><div class="container flex align-center"><div id=nav_head><a href=/ id=logo-link><img class=nav-logo src=/assets/logo.svg width=136 height=48 alt="Godot Engine">
<img class="nav-logo dark-logo" src=/assets/logo_dark.svg width=136 height=48 alt="Godot Engine"></a>
<label for=nav_toggle_cb id=nav_toggle_btn><img src=/assets/icons/hamburger.svg width=24 height=24 alt="Main menu"></label></div><nav id=nav><ul class=left><li><a href=/features>Features</a><li class=only-on-mobile><a href=/showcase>Showcase</a><li><a href=/blog>Blog</a><li><a href=/community>Community</a><li><a href=/contact>About</a><li><a href=https://godotengine.org/asset-library/asset>Assets</a></ul><ul class=right><li><a href=/download/windows class=set-os-download-url>Download</a><li><a href=https://docs.godotengine.org>Learn</a><li><a href=https://docs.godotengine.org/en/stable/community/contributing/index.html>Contribute</a><li class=fund><a href=https://fund.godotengine.org>❤&#xFE0E; Donate</a></ul></nav></div></header><main><style>body{background-color:var(--background-color)}h1{margin-bottom:8px;margin-top:32px}:not(pre)>code{background:var(--code-background-color);padding:1px 4px;font-size:.95em;border-radius:3px}pre{background:var(--codeblock-background-color);color:var(--codeblock-color)}pre code{display:block;overflow-x:auto;padding:.5em}.date-big{line-height:2;margin-left:32px}article{background-color:var(--base-color);box-shadow:0 3px 2px rgba(0,0,0,.15)}figure{margin:0}figure img{margin:0}article img,article video{max-width:100%;height:auto;display:block;margin:auto;margin-top:16px;margin-bottom:16px}article h1{margin-top:64px}article h2,article h3,article h4{margin-top:42px}.article-info{display:flex;flex-direction:column;gap:8px}.article-metadata{display:flex;gap:24px;align-items:center;font-family:var(--header-font-family);margin-bottom:12px}@media(max-width:900px){.article-metadata{flex-direction:column;align-items:flex-start;gap:16px}}.article-author{color:var(--base-color-text-subtitle-date);font-weight:700;font-size:18px;flex-grow:1;display:flex;gap:12px;align-items:center}.article-author .avatar{border-radius:100%;margin:0}.article-author .by{color:var(--base-color-text-subtitle)}.article-metadata .date{color:var(--base-color-text-subtitle-date)}.article-metadata .date.post-recent-highlight{color:var(--post-recent-highlight-color);opacity:.8}.article-metadata .date.post-recent-highlight::after{font-size:80%;content:"NEW";border:2px solid var(--post-recent-highlight-color);padding:2px 3px;margin-left:8px}.tag.active{filter:saturate(.75)}@media screen and (min-width:900px){article .content{width:70%;margin:auto}}@media(max-width:900px){body{background-color:var(--base-color)}article{background-color:initial;box-shadow:none}article img:first-child,article video:first-child{max-width:100%}}</style><link rel=stylesheet href=/assets/css/highlight.obsidian.min.css><div class=container><article class=padded><div class="content article-container"><figure class=article-cover><img src=/storage/app/uploads/public/61a/27f/881/61a27f8816a4e934017559.png title alt=" " class=rounded-lg style=width:100%;height:auto;background-color:initial></figure><div class=article-info><h1>Multiplayer in Godot 4.0: Scene Replication (part 1)</h1><div class=article-metadata><div class=article-author><span>By:</span>
<img class=avatar width=25 height=25 src=/assets/images/authors/faless.webp alt="Fabio Alessandrelli" loading=lazy>
<span class=by>Fabio Alessandrelli</span></div><span class=date data-post-date="2021-11-27 19:00:00 +0000">27 November 2021</span></div><div class=tags><a href=/blog/progress-report><div class="tag active">Progress Report</div></a></div></div><div class="card card-warning"><p>This article is from <strong>November 2021</strong>, some of its contents might be outdated and no longer accurate.<br>You can find up-to-date information about the engine in the <a href=https://docs.godotengine.org/en/stable/>official documentation</a>.</div><div class=article-body><p>Howdy Godotters!<p>It’s finally time for the long-awaited post about the new multiplayer replication system that is being developed for Godot 4.0.
Below, we will introduce the concepts around which it was designed, the currently implemented prototype, and planned changes to make it more powerful and user-friendly.<p><em>See other articles in this Godot 4.0 networking series:</em><ol><li><a href=https://godotengine.org/article/multiplayer-changes-godot-4-0-report-1>Multiplayer in Godot 4.0: On servers, RSETs and state updates</a><li><a href=https://godotengine.org/article/multiplayer-changes-godot-4-0-report-2>Multiplayer in Godot 4.0: RPC syntax, channels, ordering</a><li><a href=https://godotengine.org/article/multiplayer-changes-godot-4-0-report-3>Multiplayer in Godot 4.0: ENet wrappers, WebRTC</a><li>(you are here) <a href=https://godotengine.org/article/multiplayer-changes-godot-4-0-report-4>Multiplayer in Godot 4.0: Scene Replication (part 1)</a></ol><h2 id=design-goals>Design goals</h2><p>Making multiplayer games has historically been a complex task, requiring ad-hoc optimizations and game-specific solutions. Still, two main concepts are almost ubiquitous in multiplayer games: some form of <strong>messaging</strong>, and some form of <strong>state replication</strong> (synchronization and reconciliation).<p>While Godot does provide a system for messaging (i.e. <abbr title="Remote Procedure Calls">RPC</abbr>), it does not provide a common system for replication.<p>In this sense, we had quite a few <a href=https://chat.godotengine.org/>#networking meetings</a> in August 2021 to design a replication API that could be used for the common cases, while being extensible via plugins or custom code.<p>The design goals that emerged for such an API where:<ul><li>Provide an out-of-the-box solution for scene state replication across the network.<li>Allow for (almost) no-code prototyping.<li>Be extensible with game-specific behaviours (custom reconciliation, interpolation, interest management, etc).<li>Allow ex-post (incremental) optimizations of network code.<li>Be easy to use for game developers, of course :)</ul><h3 id=glossary>Glossary</h3><ul><li><code class="language-plaintext highlighter-rouge">State</code>: The informations (properties) about an Object relevant to the multiplayer game.<li><code class="language-plaintext highlighter-rouge">Spawn</code>: Creating, or requesting remotely to create a new Object.<li><code class="language-plaintext highlighter-rouge">Sync</code>: Updating, or requesting remotely to update the state of an Object.</ul><h3 id=security>Security</h3><p>When dealing with computer networks, it’s important to understand the security implication of transfering data across machines.
For instance, Godot does not allow <a href=https://docs.godotengine.org/en/stable/classes/class_multiplayerapi.html#class-multiplayerapi-property-allow-object-decoding>decoding objects</a> by default, since they could carry scripts with them or force the receiving end to execute specific code during initialization. This is a security vulnerability, as arbitrary code execution of this kind would allow for servers to access or manipulate any file on the client’s filesystem that the game process has access to.<p>In a similar way, the replication API will let you specify which scenes can be spawned by a remote peer. Tthe final implementation will also allow for fine-grained control over which node can be spawned at each specific path.<h3 id=optimizations>Optimizations</h3><p>Optimizations, and bandwidth optimizations in particular, are crucial to an effective networking protocol.<ul><li>Synchronizing multiple properties is very useful in the prototyping stage, but bad in terms of potential optimizations.<li>A very quick way to optimize the network code later on is to replicate a single property that returns a tightly packed representation of the object state based on your game’s unique characteristics.
When done properly, this is also going to be the most optimized state possible that no tool can produce for you.<li>The replication API will still try to squeeze the state size as much as possible with the information in its hands.</ul><h2 id=initial-prototype>Initial prototype</h2><p>With this in mind, an initial prototype was developed and has been merged in Godot’s <code class="language-plaintext highlighter-rouge">master</code> branch.
Please note that <strong>the final implementation will be substantially different</strong> in terms of exposed low-level API. Nonetheless, it will retain the same concepts and functionalities while adding more as we gather more feedback (jump to the next section for more information).<p>The initial prototype requires some wiring via GDScript, but <strong>the final version will use visual configuration nodes</strong> for better usability.<p>Without further ado, let’s create our player:<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code># player.gd
extends CharacterBody2D

# The player name.
var player_name: String


func _ready():
	print("Player spawned. Name: %s, position: %s" % [player_name, position])


func _notification(what):
	if what == NOTIFICATION_PREDELETE:
		print("Player deleted. Name: %s" % player_name)
</code></pre></div></div><p>Now let’s create our main scene, which configures the replication, and starts the networking:<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code># main.gd
extends Node

# The player scene (which we want to configure for replication).
const Player = preload("res://player.tscn")


func _ready():
	# Get the UID of the scene we want replicated.
	var id = ResourceLoader.get_resource_uid(Player.resource_path)
	# Configure the scene to be controlled by the server,
	# and which properties will be replicated during spawn.
	multiplayer.replicator.spawn_config(id, MultiplayerReplicator.REPLICATION_MODE_SERVER,
		[&amp;"player_name", &amp;"position"])
	# Configure the variables to be synchronized periodically
	# (every 16 milliseconds = 62.5 Hz).
	multiplayer.replicator.sync_config(id, 16, [&amp;"position"])

	# Start the server if Godot is passed the "--server" argument,
	# and start a client otherwise.
	if "--server" in OS.get_cmdline_args():
		start_network(true)
	else:
		start_network(false)


func start_network(server: bool):
	var peer = ENetMultiplayerPeer.new()
	if server:
		# Listen to peer connections, and create new player for them
		multiplayer.peer_connected.connect(self.create_player)
		# Listen to peer disconnections, and destroy their players
		multiplayer.peer_disconnected.connect(self.destroy_player)
		peer.create_server(4242)
	else:
		peer.create_client("localhost", 4242)

	multiplayer.set_multiplayer_peer(peer)


func create_player(id):
	# Instantiate a new player for this client.
	var p = Player.instantiate()
	# Sets the player name (only sent during spawn).
	p.player_name = "Player %d" % id
	# Set a random position (sent on every replicator update).
	p.position = Vector2(randi() % 500, randi() % 500)
	# Add it to the "Players" node.
	# We give the new Node a name for easy retrieval, but that's not necessary.
	p.name = str(id)
	$Players.add_child(p)

func destroy_player(id):
	# Delete this peer's node.
	$Players.get_node(str(id)).queue_free()
</code></pre></div></div><p>With this configuration, each new client that connects will cause the server to instantiate a new player for it.<p>Note that the client code doesn’t “instantiates” the scene explicitly. However, since the scene is marked for replication, when the server adds the scene to the SceneTree, it automatically sends that information remotely. Each connected client will then instantiate the scene automatically, adding it to the proper path and setting the values configured via <code class="language-plaintext highlighter-rouge">multiplayer.replicator.spawn_config</code> (<code class="language-plaintext highlighter-rouge">position</code> and <code class="language-plaintext highlighter-rouge">player_name</code> in this example).<p>Additinally, the server automatically keeps track of replicated nodes to send them to newly connected peers, i.e. supporting clients that join mid-game.<p>The RPC system will also work appropriately for the nodes spawned this way, so you can easily integrate state synchronization with messaging.<p>At the specified interval (16 milliseconds in the above example), the properties passed to <code class="language-plaintext highlighter-rouge">multiplayer.replicator.sync_config</code> will also be synchronized from the server to the client.<p>You can decide to synchronize multiple properties via <code class="language-plaintext highlighter-rouge">sync_config</code>, but keep in mind that will result in a larger sync state. If the sync state becomes too large, this can potentially introduce latency or packet loss.<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>multiplayer.replicator.sync_config(id, 16, [&amp;"position", &amp;"health", &amp;"mana"])
</code></pre></div></div><p>In those cases, a good way to optimize the state is to use a dedicated “sync_state” property with your own optimized representation:<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>multiplayer.replicator.sync_config(id, 16, [&amp;"sync_state"])
</code></pre></div></div><p>And then in your player script:<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code># player.gd

# In this example, health and mana must be set between 0 and 255
# to be encoded as 8-bit integers.
var health := 100
var mana := 100

# Optimized state representation using bit-packing.
var sync_state:
	get:
		var buf = PackedByteArray()
		buf.resize(6)
		buf.encode_half(0, position.x)
		buf.encode_half(2, position.y)
		buf.encode_u8(4, health)
		buf.encode_u8(5, mana)
		return buf

	set(value):
		assert(typeof(value) == TYPE_RAW_ARRAY and value.size() == 6,
		    "Invalid `sync_state` array type or size (must be TYPE_RAW_ARRAY of size 6).")
		position = Vector2(value.decode_half(0), value.decode_half(2))
		health = value.decode_u8(4)
		mana = value.decode_u8(5)
</code></pre></div></div><p>In the same way, properties of child nodes could be set, and custom interpolation techniques implemented.<h2 id=future-work>Future work</h2><p>As explained, this is an early prototype. A <a href=https://github.com/godotengine/godot-proposals/issues/3459>more complete proposal</a> has been created to gather feedback as we work towards a final implementation in the coming months. This includes <strong>visual configuration</strong>, child node properties support, fine grained spawn control and more.<p>The coming months will be prety dense of announcements. As always, stay tuned for more!<h2 id=references>References</h2><ul><li><a href=https://github.com/godotengine/godot/pull/51097>Spawn/Despawn pull request</a><li><a href=https://github.com/godotengine/godot/pull/51534>Spawn/Despawn initial state pull request</a><li><a href=https://github.com/godotengine/godot/pull/51788>State synchronization pull request</a><li><a href=https://github.com/godotengine/godot-proposals/issues/3459>Last replication proposal</a> (ongoing).</ul></div></div></article></div><link rel=stylesheet href=/assets/css/anchor-link.css?1><link rel=stylesheet href=/assets/css/article-cards.css?2><script src=/assets/js/anchor-link.js></script>
<script>document.addEventListener('DOMContentLoaded',()=>{window.applyAnchorLinks('.article-body'),document.querySelectorAll('.article-cover img, .article-body img').forEach(b=>{if(b.classList.contains('lightbox-ignore'))return;const a=document.createElement('a');a.href=b.src,a.classList.add('lightbox'),a.dataset.group='article',b.parentNode.appendChild(a),a.appendChild(b)})})</script></main><footer><div class="container flex footer-container"><div id=copyright><p>© 2007-2024 Juan Linietsky, Ariel Manzur and <a href=https://github.com/godotengine/godot/blob/master/AUTHORS.md target=_blank rel=noopener>contributors</a>.<br>Hosted by the <a href=https://godot.foundation/ target=_blank rel=noopener>Godot Foundation</a>.<br>Website <a href=https://github.com/godotengine/godot-website target=_blank rel=noopener>source code on GitHub</a>.</div><div id=sitemap><ul class=sitemap-group><li><strong>Get Godot</strong><li><a href=/download/windows class=set-os-download-url>Download</a><li><a href=https://editor.godotengine.org/releases/latest/>Web Editor</a><li>&nbsp;<li><strong>Public Relations</strong><li><a href=/blog>Blog</a><li><a href=/community>Communities and Events</a><li><a href=/press>Press Kit</a></ul><ul class=sitemap-group><li><strong>About Godot</strong><li><a href=/features>Features</a><li><a href=/showcase>Showcase</a><li><a href=/education>Education</a><li><a href=/license>License</a><li><a href=/code-of-conduct>Code of Conduct</a><li><a href=/privacy-policy>Privacy Policy</a><li><a href=https://fund.godotengine.org>Donate</a></ul><ul class=sitemap-group><li><strong>Project Team</strong><li><a href=/governance>Governance</a><li><a href=/teams>Teams</a><li>&nbsp;<li><strong>Extra Resources</strong><li><a href=/asset-library/asset>Asset Library</a><li><a href=https://docs.godotengine.org>Documentation</a><li><a href=https://github.com/godotengine>Code Repository</a></ul></div><div id=social class=dark-desaturate><h4 class=text-right><a href=/contact>Contact us</a></h4><div class="flex justify-space-between" style=gap:3px><a href=https://github.com/godotengine target=_blank rel=noopener><img src=/assets/footer/github_logo.svg width=32 height=32 alt=GitHub></a>
<a href=https://mastodon.gamedev.place/@godotengine target=_blank rel=noopener><img src=/assets/footer/mastodon_logo.svg width=32 height=32 alt=Mastodon></a>
<a href=https://twitter.com/godotengine target=_blank rel=noopener><img src=/assets/footer/twitter_logo.svg width=32 height=32 alt=Twitter></a>
<a href=https://www.facebook.com/groups/godotengine/ target=_blank rel=noopener><img src=/assets/footer/facebook_logo.svg width=32 height=32 alt=Facebook></a>
<a href=https://www.reddit.com/r/godot target=_blank rel=noopener><img src=/assets/footer/reddit_logo.svg width=32 height=32 alt=Red​dit></a>
<a href=/rss.xml target=_blank rel=noopener><img src=/assets/footer/feed_logo.svg width=32 height=32 alt="RSS feed"></a></div></div></div></footer><script defer src=/assets/js/tobii.min.js></script>
<script defer src=/assets/js/highlight.min.js?1></script>
<script defer src=/assets/js/highlight.gdscript.min.js?1></script>
<script>document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('pre code').forEach(a=>{hljs.highlightBlock(a)}),document.querySelectorAll('[data-post-date]').forEach(a=>{Date.parse(a.dataset.postDate)>Date.now()-1e3*60*60*48&&a.classList.add("post-recent-highlight")}),new Tobii({zoom:!1});const a=document.querySelectorAll('.set-os-download-url');for(let b=0;b<a.length;b++){const c=a[b];let e='download';'version'in c.dataset&&c.dataset.version==='3'&&(e='download/3.x');let d='windows';navigator.platform.indexOf('Mac')!==-1?d='macos':navigator.platform.indexOf('Linux')!==-1&&(d='linux'),c.href=`/${e}/${d}`}})</script>